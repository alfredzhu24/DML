!Changelog
!Change 001 - Altered to just call SOPC_R_SHIP_DOC_PRINT, which is our custom program to generate documents needed at print time (COA, BOL, PL, etc)

TITLE SOP_R_009,"Print Unconfirmed Despatch Notes"
	
PROCEDURE_FORM SALES_DESPATCH_ENTRY (#P1,#P2,#P3)

	BEGIN_BLOCK DOCUMENTATION
		!	=====================================================
		!
		!	(c) Copyright 1988-2006 Ross Systems, Inc.
		!	All Rights Reserved
		!
		!	This program is the proprietary and confidential information
		!	of Ross Systems, Inc. and may be used and disclosed only
		!	as authorized in a license agreement authorizing and
		!	controlling such use and disclosure
		!
		!	=====================================================
	END_BLOCK

	BEGIN_BLOCK CHECK_PARAMETERS
		#INSTRUCTION		= #P1
		#DIVISION		= #P2
		#DESPATCH_NOTES		= #P3
		#NO			= PARAMETER("LANGUAGE_NO")
		#MODE 			= #NO
		#TM_IN_USE		= #NO
		#SOP_ORDER_CYCLE_B	= PARAMETER("SOP_ORDER_CYCLE_B")

		IF  (#MODULE = "")  #MODULE = PARAMETER("MODULE_SY")
		
		!Change 001
		!PERFORM SALES_MAIN (#MODE)
		PERFORM "GEMSOP:SOPC_R_SHIP_DOC_PRINT"
		!Change 001 End
	END_BLOCK

END_FORM

PROCEDURE_FORM SHIPPING_ENTRY (#P1, #P2, #P3, #P4)

	BEGIN_BLOCK DOC
	END_BLOCK

	BEGIN_BLOCK CHECK_PARAMETERS
		#INSTRUCTION		= #P1
		#DIVISION		= #P2
		#SHIPPING_RUN_NUMBER 	= #P3
		#SOP_LOAD_ID		= #P4
		#DESPATCH_NOTES		= ""
		#NO			= PARAMETER("LANGUAGE_NO")
		#YES			= PARAMETER("LANGUAGE_YES")
		#MODE 			= #NO
		#TM_IN_USE		= #YES
		#SOP_ORDER_CYCLE_B	= PARAMETER("SOP_ORDER_CYCLE_B")

		IF  (#MODULE = "")  #MODULE = PARAMETER("MODULE_SY")

		!Change 001
		!PERFORM SHIPPING_MAIN (#MODE)
		PERFORM "GEMSOP:SOPC_R_SHIP_DOC_PRINT" 
		!Change 001 End
	END_BLOCK

END_FORM


PROCEDURE_FORM AUTO_ENTRY (#P1,#P2,#P3,#P4,#P5,#P6,#P7,#P8,#P9)
!Change 001
	BEGIN_BLOCK SETUP
		#DIVISION		= #P1
		#DESPATCH_NOTES 	= #P2
		#PREPRINTED 		= #P3
		#LANGUAGE_CODE 		= #P4
		#ACCESSIBLE_WAREHOUSES  = #P5
		#FOF_FORMAT		= #P6
		#SHIPPING_RUN_NUMBER 	= #P7
		#SOP_LOAD_ID		= #P8
		#RUN_TYPE		= #P9	
	END_BLOCK

	BEGIN_BLOCK CALL_PRINTING
		PERFORM "GEMSOP:SOPC_R_SHIP_DOC_PRINT" ("Y",#DESPATCH_NOTES)
	END_BLOCK
END_FORM

PROCEDURE_FORM AUTO_ENTRY_ROSS_ORIGINAL (#P1,#P2,#P3,#P4,#P5,#P6,#P7,#P8,#P9)
!Change 001 End
	BEGIN_BLOCK SETUP
		#DIVISION		= #P1
		#DESPATCH_NOTES 	= #P2
		#PREPRINTED 		= #P3
		#LANGUAGE_CODE 		= #P4
		#ACCESSIBLE_WAREHOUSES  = #P5
		#FOF_FORMAT		= #P6
		#SHIPPING_RUN_NUMBER 	= #P7
		#SOP_LOAD_ID		= #P8
		#RUN_TYPE		= #P9

		#TM_IN_USE		= #NO
		#SOP_ORDER_CYCLE_B	= PARAMETER("SOP_ORDER_CYCLE_B")
		#COMPANY_CODE		= PARAMETER("USER_COMPANY_CODE")
		
		! We must ensure that the report name is correct so force the ID 
		! field to be the facility id for this program not the calling program.
		IF (#RUN_TYPE = "SHIP")
			#ID			= "SOP_R_009A"
		ELSE
			#ID			= "SOP_R_009B"
		END_IF
		
		#YES			= PARAMETER("LANGUAGE_YES")
		#NO			= PARAMETER("LANGUAGE_NO")
		#PICK			= #NO
		#SECURITY_ACTIVE	= PARAMETER("COMPANY_SECURITY_ACTIVE")

		IF  (#MODULE = "")  #MODULE = PARAMETER("MODULE_SY")

		FIND IN AR_CONTROLS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION

		IF (%STATUS = %FAILURE)
			MESSAGE/IDENTIFIER P_00354
			EXIT(%FAILURE)
		END_IF
		#PHYSICAL_UNITS_IN_USE = AR_CONTROLS(PHYSICAL_UNITS_IN_USE)

	END_BLOCK

	BEGIN_BLOCK DESPATCH_PRINT
		IF (#RUN_TYPE = "SHIP")
			FIND IN SOP_SHIPPING_RUN_CONTROL	&
				/LOCK=NONE	&
				/WITH=COMPANY_CODE=#COMPANY_CODE	&
				/WITH=DIVISION=#DIVISION	&
				/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER
			IF (%STATUS <> %SUCCESS)
				MESSAGE/IDENTIFIER P_85089
				EXIT(%FAILURE)
			END_IF

			FIND IN DESPATCH_NOTES	&
				/LOCK=NONE	&
				/WITH=COMPANY_CODE = #COMPANY_CODE	&
				/WITH=DIVISION = #DIVISION	&
				/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER	&
				/WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID	&
				/WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES

			IF (%STATUS <> %SUCCESS)
				MESSAGE/IDENTIFIER P_85090
				EXIT(%FAILURE)
			END_IF

			#TM_IN_USE = #YES
		ELSE
			#TM_IN_USE = #NO
		END_IF

		COMMIT
		PERFORM DESPATCH_PRINT_CONTROL
		IF (#FOF_FORMAT=#YES) PERFORM FOF_GENERATE_REPORT
	END_BLOCK
END_FORM


PROCEDURE_FORM RS_SHIP_NOTE_PRINT_ENTRY (#R1)

	BEGIN_BLOCK DOCUMENTATION 
		!-------------------------------------------------------------
		! This entry form is called from RS_SHIP_NOTE_PRINT which
		! is part of the Ship Amend Web Service suite. This form is 
		! similar to AUTO_ENTRY above but is customized specifically 
		! for the Web Service call. The Ship Note report is performed
		! without any user interaction.
		!-------------------------------------------------------------
	END_BLOCK 

	BEGIN_BLOCK SETUP

		! Define constants
		
		#YES			= PARAMETER("LANGUAGE_YES")
		#NO			= PARAMETER("LANGUAGE_NO")
		#SYS_YES		= PARAMETER("SYS_YES")
		!#SYS_NO		= PARAMETER("SYS_NO")
		#ERR_FATAL     		= PARAMETER("MESSAGE_ERROR_FATAL")
		#ERR_WARN     		= PARAMETER("MESSAGE_ERROR_WARN")
		#ERR_INFO  		= PARAMETER("MESSAGE_ERROR_INFO")
		#SOP_ORDER_CYCLE_B	= PARAMETER("SOP_ORDER_CYCLE_B")
		#DEFAULT_LANGUAGE	= PARAMETER("SYS_DEFAULT_LANGUAGE")
		#CALL_MODE_WS		= PARAMETER("CALL_MODE_W")

		! Define variables

		#MODULE 		= PARAMETER("MODULE_SO")
		#CALL_MODE		= PARAMETER("CALL_MODE_W")
		#RUN_TYPE		= "SALES"
		#ID			= "SOP_R_009"
		#ACCESSIBLE_WAREHOUSES  = "*"
		#FOF_FORMAT		= #NO
		#TM_IN_USE		= #NO
		#PICK			= #NO
		#SHIPPING_RUN_NUMBER 	= ""
		#SOP_LOAD_ID		= ""

		! Set default return parameter value

		#R1			= #ERR_INFO

		! Get Web Service control data

		START_TRANSACTION

		FIND IN RS_SHIP_NOTE_PRINT &
			/LOCK=NONE

		IF (%STATUS <> %SUCCESS ) 
			ROLLBACK
			! "Control record missing from !AS"
			PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
				("FIN", "P_13921", "", #ERR_FATAL, 0, "RS_SHIP_NOTE_PRINT", "", "", "", "")
			GOTO END_FAILURE
		END_IF 		
	
		#COMPANY_CODE		= RS_SHIP_NOTE_PRINT(COMPANY_CODE)
		#DIVISION		= RS_SHIP_NOTE_PRINT(DIVISION)
		#DESPATCH_NOTES		= RS_SHIP_NOTE_PRINT(SOP_SHIPPING_NOTES)
		#PREPRINTED		= RS_SHIP_NOTE_PRINT(PRE_PRINTED_FLAG)
		#LANGUAGE_CODE		= RS_SHIP_NOTE_PRINT(LANGUAGE_CODE)
				
		IF (#PREPRINTED = #SYS_YES)
			#PREPRINTED = #YES
		ELSE
			#PREPRINTED = #NO 
		END_IF 
	
		IF (#LANGUAGE_CODE = "") 
			#LANGUAGE_CODE = #DEFAULT_LANGUAGE		
		END_IF 
		
		! Get division controls

		FIND IN AR_CONTROLS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION

		IF (%STATUS <> %SUCCESS)
			ROLLBACK
			! "AR_CONTROLS record not found for division !AS"
			PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
				("FIN", "P_51905", "", #ERR_FATAL, 0, #DIVISION, "", "", "", "")
			GOTO END_FAILURE
		END_IF

		#PHYSICAL_UNITS_IN_USE	= AR_CONTROLS(PHYSICAL_UNITS_IN_USE)

		COMMIT

		! Perform report

		PERFORM DESPATCH_PRINT_CONTROL

		IF (%STATUS <> %SUCCESS)
			GOTO END_FAILURE
		END_IF

		GOTO END_SUCCESS

	END_BLOCK

	BEGIN_BLOCK END_SUCCESS

		#R1 = #ERR_INFO
		EXIT (%SUCCESS)

	END_BLOCK

	BEGIN_BLOCK END_FAILURE

		#R1 = #ERR_FATAL
		EXIT (%FAILURE)
		
	END_BLOCK

END_FORM


FORM SALES_MAIN (#MODE) /ROW=3 /COL=2 /HEIGHT=21 /WIDTH=78 &
	/TITLE=(MESSAGE("P_50017"))

	BEGIN_BLOCK SETUP
		START_TRANSACTION

		#COMPANY_CODE		= PARAMETER("USER_COMPANY_CODE")
		#ID			= PARAMETER("FACILITY_ID")
		#YES			= PARAMETER("LANGUAGE_YES")
		#NO			= PARAMETER("LANGUAGE_NO")
		#PICK			= #MODE
		#SECURITY_ACTIVE	= PARAMETER("COMPANY_SECURITY_ACTIVE")

		IF (#SECURITY_ACTIVE = #YES)
			FIND IN SECURITY_TRAN_TYPES_VT &
				/WITH=SOURCE_MODULE=(PARAMETER("MODULE_SO")) &
				/WITH=SECURITY_TRANSACTION_TYPE=(PARAMETER("TTYPE_DR"))

			IF (%STATUS = %FAILURE  OR &
				SECURITY_TRAN_TYPES_VT(CREATE_TRANSACTIONS) <> #YES)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00897,PARAMETER("TTYPE_DR")
				ROLLBACK
				EXIT(%FAILURE)
			END_IF
		END_IF

		! Security. Get a string of all accessible Warehouses.
		!

		PERFORM "GEMLB:LB_SECURITY_CODE_ACCESS" &
			((PARAMETER("MODULE_SO")), &
			 PARAMETER("ACCESS_TYPE_WAREHOUSE"), &
			 #ACCESSIBLE_WAREHOUSES)

		IF	(%STATUS=%FAILURE)
			MESSAGE/IDENTIFIER/BELL/WAIT P_10638
			EXIT (%FAILURE)
		END_IF

		IF (#ACCESSIBLE_WAREHOUSES = "##NONE##")
			MESSAGE/IDENTIFIER/BELL/WAIT P_10639,PARAMETER("MODULE_SO")
		                     EXIT (%FAILURE)
		END_IF
	END_BLOCK

	BEGIN_BLOCK DIVISION
		INPUT_BLOCK  /ROW=3 /COL=35 &
			/PROMPT=(FIELD_PROMPT(DIVISION)) &
			/TARGET=#DIVISION &
			/USING=DESPATCH_NOTES(DIVISION) &
			/LOV=SECURITY_PERIOD_ACCESS_VT(SYS_ACCESS_CODE,CODE_DESCRIPTION) &
			/LOV_WITH=SYS_ACCESS_TYPE=(PARAMETER("ACCESS_TYPE_DIVISION")) &
			/LOV_WITH=SOURCE_MODULE=(PARAMETER("MODULE_SO")) &
			/LOV_WITH=SYS_ALLOW_ACCESS=#YES &
			/USE_IF=(#INSTRUCTION<>MESSAGE("P_36101"))

		IF (#INSTRUCTION <> MESSAGE("P_36101"))
			FIND IN AR_CONTROLS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=DIVISION=#DIVISION

			IF (%STATUS = %FAILURE)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00354
				GOTO DIVISION
			END_IF

			FIND IN SECURITY_PERIOD_ACCESS_VT &
				/WITH=SYS_ACCESS_TYPE=(PARAMETER("ACCESS_TYPE_DIVISION")) &
				/WITH=SYS_ACCESS_CODE=#DIVISION &
				/WITH=SOURCE_MODULE=(PARAMETER("MODULE_SO"))

			IF  (%STATUS = %FAILURE)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00447
				GOTO DIVISION
			END_IF

			IF  (SECURITY_PERIOD_ACCESS_VT(SYS_ALLOW_ACCESS) <> #YES)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00756
				GOTO DIVISION
			END_IF
		END_IF

		#NATIVE_LANGUAGE_CODE = AR_CONTROLS(SYS_LANGUAGE_CODE)
		#PHYSICAL_UNITS_IN_USE = AR_CONTROLS(PHYSICAL_UNITS_IN_USE)

	END_BLOCK

	OUTPUT_BLOCK DIV_NAME /ROW=3 /COL=38 &
			/SOURCE=(AR_CONTROLS(DIVISION_NAME)) &
			/USE_IF=(#INSTRUCTION<>MESSAGE("P_36101"))

	INPUT_BLOCK DESPATCH_NOTES /ROW=5 /COL=35 &
			/PROMPT=(FIELD_PROMPT(DESPATCH_NOTE)) &
			/TARGET=#DESPATCH_NOTES &
			/TITLE=(FIELD_PROMPT(DESPATCH_NOTE)) &
			/USING=DESPATCH_NOTES(DESPATCH_NOTE),MULTIPLE &
			/LOV=DESPATCH_NOTES(DESPATCH_NOTE,CUSTOMER_NUMBER,WAREHOUSE) &
			/LOV_WITH=COMPANY_CODE=#COMPANY_CODE &
			/LOV_WITH=DIVISION=#DIVISION &
			/LOV_WITH= CONFIRM_DESPATCH <> #YES &
			/LOV_WITH = TM_LOAD_PLANNING <> #YES	&
			/LOV_WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
			/LOV_WITH=WAREHOUSE = "" &
			/LOV_WITH=WAREHOUSE MISSING &
			/LOV_SELECTION="A AND B AND C AND (D OR E OR F)" &
			/LOV_SORTED_BY=DESPATCH_NOTE &
			/LOV_REDUCED_TO=(DESPATCH_NOTE) &
			/USE_IF=(#INSTRUCTION<>MESSAGE("P_36101"))

	INPUT_BLOCK PRINT_FLAG /ROW=7 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SYS_PREPRINTED_FLAG)) &
			/TARGET=#PREPRINTED &
			/USING=AP_CONTROLS_CHECK_RUNS(SYS_PREPRINTED_FLAG),REQUIRED

	INPUT_BLOCK LANGUAGE /ROW=8 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SYS_LANGUAGE_CODE)) &
			/SOURCE=(AR_CONTROLS(SYS_LANGUAGE_CODE)) &
			/TARGET=#LANGUAGE_CODE &
			/USING=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE) &
			/LOV=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE,SYS_CODE_DESCRIPTION) &
			/USE_IF=(#PREPRINTED = #YES)

	INPUT_BLOCK MULTI_LANGUAGE /ROW=8 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SYS_LANGUAGE_CODE)) &
			/TARGET=#LANGUAGE_CODE &
			/TITLE=(FIELD_PROMPT(SYS_LANGUAGE_CODE)) &
			/USING=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE),MULTIPLE &
			/LOV=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE,SYS_CODE_DESCRIPTION) &
			/USE_IF=(#PREPRINTED <> #YES)

!FBC FOF_001 begin
	START_TRANSACTION

	FIND IN SOURCE_MODULES &
		/LOCK=READ &
		/WITH=SOURCE_MODULE=PARAMETER('MODULE_FO')

	IF (%STATUS=%NORMAL)
		#FOF_ACTIVE=SOURCE_MODULES(MODULE_IN_USE)
		FIND IN FOF_CONTROLS &
			/LOCK=READ

		IF (%STATUS=%NORMAL)
			#FOF_AUTOPRINT=FOF_CONTROLS(FOF_AUTOPRINT)
		END_IF
		#FOF_FORMAT=#FOF_AUTOPRINT

	ELSE
		#FOF_ACTIVE=#NO
	END_IF
	COMMIT

	YESNO_BLOCK FOF_FORMAT /ROW=10 /COL=35 &
			/PROMPT=(MESSAGE("P_71931")) &
			/SUCCESS=(#FOF_FORMAT=#YES) &
			/FAILURE=(#FOF_FORMAT=#NO) &
			/USE_IF=(#FOF_ACTIVE=#YES AND #FOF_AUTOPRINT<>#YES)

	MENU_BLOCK MENU /ROW=12 /COL=26 &
!	MENU_BLOCK MENU /ROW=10 /COL=26 &
!FBC FOF_001 End
			/SOURCE=(PARAMETER("REPORT_MENU_DEFAULT")) &
			/SOURCE=(PARAMETER("REPORT_MENU_DEFAULT")) &
			/ITEM=(MESSAGE("P_00116")),(MESSAGE("P_54004")),(GOTO REPORT) &
			/ITEM=(MESSAGE("P_00067")),(MESSAGE("P_54001")),(GOTO BATCH) &
			/ITEM=(MESSAGE("P_00257")),(MESSAGE("P_00263")),(EXIT)

	BEGIN_BLOCK REPORT
		COMMIT

		PERFORM DESPATCH_PRINT_CONTROL
!FBC FOF_001 Begin
		COMMIT
		IF (#FOF_FORMAT=#YES)
			PERFORM FOF_GENERATE_REPORT
		END_IF
!FBC FOF_001 End
		EXIT
	END_BLOCK

	BEGIN_BLOCK BATCH
		PERFORM/BATCH 'GEMSYS:SYS_COMPANY_SETUP' BATCH_ENTRY ( &
				#COMPANY_CODE, &
				"GEMSOP:SOP_R_DESPATCH_PRINT", &
				'SALES_BATCH_SETUP', &
				 #COMPANY_CODE,&
				 #COMPANY_NAME, &
				 #DIVISION, &
				 #DESPATCH_NOTES, &
				 #PREPRINTED, &
				 #LANGUAGE_CODE, &
				 #NATIVE_LANGUAGE_CODE, &
				 #ID, &
				 #ACCESSIBLE_WAREHOUSES, &
				 #FOF_FORMAT)

		EXIT
	END_BLOCK

END_FORM

FORM SHIPPING_MAIN (#MODE) /ROW=3 /COL=2 /HEIGHT=21 /WIDTH=78 &
	/TITLE=(MESSAGE("P_50017"))

	BEGIN_BLOCK SETUP
		START_TRANSACTION

		#COMPANY_CODE		= PARAMETER("USER_COMPANY_CODE")
		#ID			= PARAMETER("FACILITY_ID")
		#YES			= PARAMETER("LANGUAGE_YES")
		#NO			= PARAMETER("LANGUAGE_NO")
		#PICK			= #MODE
		#SECURITY_ACTIVE	= PARAMETER("COMPANY_SECURITY_ACTIVE")
		#DIVISION		= PARAMETER("TM_USER_AR_DIVISION")
!		#AP_DIVISION		= PARAMETER("TM_USER_AP_DIVISION")

		IF (#SECURITY_ACTIVE = #YES)
			FIND IN SECURITY_TRAN_TYPES_VT &
				/WITH=SOURCE_MODULE=(PARAMETER("MODULE_SO")) &
				/WITH=SECURITY_TRANSACTION_TYPE=(PARAMETER("TTYPE_DR"))

			IF (%STATUS = %FAILURE  OR &
				SECURITY_TRAN_TYPES_VT(CREATE_TRANSACTIONS) <> #YES)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00897,PARAMETER("TTYPE_DR")
				ROLLBACK
				EXIT(%FAILURE)
			END_IF
		END_IF

		! Security. Get a string of all accessible Warehouses.
		!
		PERFORM "GEMLB:LB_SECURITY_CODE_ACCESS" &
			((PARAMETER("MODULE_SO")), &
			 PARAMETER("ACCESS_TYPE_WAREHOUSE"), &
			 #ACCESSIBLE_WAREHOUSES)

		IF	(%STATUS=%FAILURE)
			MESSAGE/IDENTIFIER/BELL/WAIT P_10638
			EXIT (%FAILURE)
		END_IF

		IF (#ACCESSIBLE_WAREHOUSES = "##NONE##")
			MESSAGE/IDENTIFIER/BELL/WAIT P_10639,PARAMETER("MODULE_SO")
		                     EXIT (%FAILURE)
		END_IF
	END_BLOCK

	BEGIN_BLOCK DIVISION
		INPUT_BLOCK  /ROW=3 /COL=35 &
			/PROMPT=(FIELD_PROMPT(DIVISION)) &
			/TARGET=#DIVISION &
			/USING=DESPATCH_NOTES(DIVISION) &
			/LOV=SECURITY_PERIOD_ACCESS_VT(SYS_ACCESS_CODE,CODE_DESCRIPTION) &
			/LOV_WITH=SYS_ACCESS_TYPE=(PARAMETER("ACCESS_TYPE_DIVISION")) &
			/LOV_WITH=SOURCE_MODULE=(PARAMETER("MODULE_SO")) &
			/LOV_WITH=SYS_ALLOW_ACCESS=#YES &
			/USE_IF=(#INSTRUCTION<>MESSAGE("P_36101"))

		IF (#INSTRUCTION <> MESSAGE("P_36101"))
			FIND IN AR_CONTROLS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=DIVISION=#DIVISION

			IF (%STATUS = %FAILURE)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00354
				GOTO DIVISION
			END_IF

			FIND IN SECURITY_PERIOD_ACCESS_VT &
				/WITH=SYS_ACCESS_TYPE=(PARAMETER("ACCESS_TYPE_DIVISION")) &
				/WITH=SYS_ACCESS_CODE=#DIVISION &
				/WITH=SOURCE_MODULE=(PARAMETER("MODULE_SO"))

			IF  (%STATUS = %FAILURE)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00447
				GOTO DIVISION
			END_IF

			IF  (SECURITY_PERIOD_ACCESS_VT(SYS_ALLOW_ACCESS) <> #YES)
				MESSAGE/IDENTIFIER/BELL/WAIT P_00756
				GOTO DIVISION
			END_IF
		END_IF

		#NATIVE_LANGUAGE_CODE = AR_CONTROLS(SYS_LANGUAGE_CODE)
	END_BLOCK

	OUTPUT_BLOCK DIV_NAME /ROW=3 /COL=38 &
			/SOURCE=(AR_CONTROLS(DIVISION_NAME)) &
			/USE_IF=(#INSTRUCTION<>MESSAGE("P_36101"))

	BEGIN_BLOCK SOP_SHIPPING_RUN_NUMBER
		INPUT_BLOCK /ROW=5 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SOP_SHIPPING_RUN_NUMBER)) &
			/TARGET=#SHIPPING_RUN_NUMBER &
			/USING=SOP_SHIPPING_RUN_CONTROL(SOP_SHIPPING_RUN_NUMBER),REQUIRED &
			/LOV = DESPATCH_NOTES(SOP_SHIPPING_RUN_NUMBER, DESPATCH_NOTE, CUSTOMER_NUMBER, WAREHOUSE) &
			/LOV_WITH=COMPANY_CODE=#COMPANY_CODE &
			/LOV_WITH=DIVISION=#DIVISION &
			/LOV_WITH=SOP_SHIPPING_RUN_NUMBER <> 0	&
			/LOV_WITH = TM_LOAD_PLANNING = #YES	&
			/LOV_SORTED_BY = SOP_SHIPPING_RUN_NUMBER	&
			/LOV_REDUCED_TO=SOP_SHIPPING_RUN_NUMBER
		FIND IN SOP_SHIPPING_RUN_CONTROL	&
			/LOCK=NONE	&
			/WITH=COMPANY_CODE=#COMPANY_CODE	&
			/WITH=DIVISION=#DIVISION	&
			/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER
		IF (%STATUS <> %SUCCESS)
			MESSAGE/IDENTIFIER/BELL/WAIT P_85089
			GOTO SOP_SHIPPING_RUN_NUMBER
		END_IF
	END_BLOCK

	INPUT_BLOCK SOP_LOAD_ID /ROW=7 /COL=35 &
		/PROMPT=(FIELD_PROMPT(SOP_LOAD_ID)) &
		/TARGET=#SOP_LOAD_ID &
		/USING = TM_SHIPMENT_LOAD(SOP_LOAD_ID), MULTIPLE	&
		/LOV = TM_SHIPMENT_LOAD(SOP_LOAD_ID, TM_LOAD_NUMBER, TM_ORDER_NUMBER, TM_CARGO_TYPE) &
		/LOV_WITH=COMPANY_CODE=#COMPANY_CODE &
		/LOV_WITH=DIVISION=#DIVISION &
		/LOV_WITH = SOP_SHIPPING_RUN_NUMBER=#SHIPPING_RUN_NUMBER &
		/LOV_REDUCED_TO = SOP_LOAD_ID

	INPUT_BLOCK DESPATCH_NOTES /ROW=9 /COL=35 &
			/PROMPT=(FIELD_PROMPT(DESPATCH_NOTE)) &
			/TARGET=#DESPATCH_NOTES &
			/USING=DESPATCH_NOTES(DESPATCH_NOTE),MULTIPLE &
			/LOV=DESPATCH_NOTES(DESPATCH_NOTE,CUSTOMER_NUMBER,DELIVERY_ADDRESS_CODE,PRINT_FLAG) &
			/LOV_WITH=COMPANY_CODE=#COMPANY_CODE &
			/LOV_WITH=DIVISION=#DIVISION &
			/LOV_WITH=SOP_SHIPPING_RUN_NUMBER=#SHIPPING_RUN_NUMBER &
			/LOV_WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID

	BEGIN_BLOCK CHECK_PRINTED
		FIND IN DESPATCH_NOTES	&
			/LOCK=NONE	&
			/WITH=COMPANY_CODE = #COMPANY_CODE	&
			/WITH=DIVISION = #DIVISION	&
			/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER	&
			/WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID	&
			/WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES

		IF (%STATUS <> %SUCCESS)
			MESSAGE/IDENTIFIER/BELL/WAIT P_85090
			GOTO DESPATCH_NOTES
		END_IF
	END_BLOCK

	INPUT_BLOCK PRINT_FLAG /ROW=11 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SYS_PREPRINTED_FLAG)) &
			/TARGET=#PREPRINTED &
			/USING=AP_CONTROLS_CHECK_RUNS(SYS_PREPRINTED_FLAG),REQUIRED

	INPUT_BLOCK LANGUAGE /ROW=12 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SYS_LANGUAGE_CODE)) &
			/SOURCE=(AR_CONTROLS(SYS_LANGUAGE_CODE)) &
			/TARGET=#LANGUAGE_CODE &
			/USING=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE) &
			/LOV=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE,SYS_CODE_DESCRIPTION) &
			/USE_IF=(#PREPRINTED = #YES)

	INPUT_BLOCK MULTI_LANGUAGE /ROW=12 /COL=35 &
			/PROMPT=(FIELD_PROMPT(SYS_LANGUAGE_CODE)) &
			/TARGET=#LANGUAGE_CODE &
			/TITLE=(FIELD_PROMPT(SYS_LANGUAGE_CODE)) &
			/USING=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE),MULTIPLE &
			/LOV=SYS_LANGUAGE_CODES(SYS_LANGUAGE_CODE,SYS_CODE_DESCRIPTION) &
			/USE_IF=(#PREPRINTED <> #YES)

	MENU_BLOCK MENU /ROW=16 /COL=26 &
			/SOURCE=(PARAMETER("REPORT_MENU_DEFAULT")) &
			/ITEM=(MESSAGE("P_00116")),(MESSAGE("P_54004")),(GOTO REPORT) &
			/ITEM=(MESSAGE("P_00067")),(MESSAGE("P_54001")),(GOTO BATCH) &
			/ITEM=(MESSAGE("P_00257")),(MESSAGE("P_00263")),(EXIT)

	BEGIN_BLOCK REPORT
		COMMIT

		PERFORM DESPATCH_PRINT_CONTROL

		IF (%STATUS<>%SUCCESS)
			EXIT (%STATUS)
		END_IF

		EXIT
	END_BLOCK

	BEGIN_BLOCK BATCH

		PERFORM/BATCH 'GEMSYS:SYS_COMPANY_SETUP' BATCH_ENTRY ( &
				#COMPANY_CODE, &
				"GEMSOP:SOP_R_DESPATCH_PRINT", &
				'SHIPPING_BATCH_SETUP', &
				 #COMPANY_CODE,&
				 #COMPANY_NAME, &
				 #ID, &
				 #DIVISION, &
				 #SHIPPING_RUN_NUMBER, &
				 #SOP_LOAD_ID, &
				 #DESPATCH_NOTES, &
				 #PREPRINTED, &
				 #LANGUAGE_CODE, &
				 #NATIVE_LANGUAGE_CODE, &
				 #ACCESSIBLE_WAREHOUSES)
		EXIT
	END_BLOCK

END_FORM

PROCEDURE_FORM SALES_BATCH_SETUP (#C,#C1,#P1,#P2,#P3,#P4,#P5,#I,#P6,#P7)

	BEGIN_BLOCK SETUP
		#COMPANY_CODE		= #C
		#COMPANY_NAME		= #C1
		#DIVISION			= #P1
		#DESPATCH_NOTES 	= #P2
		#PREPRINTED 		= #P3
		#LANGUAGE_CODE 		= #P4
		#NATIVE_LANGUAGE_CODE 	= #P5
		#ID 				= #I
		#ACCESSIBLE_WAREHOUSES	= #P6
		#FOF_FORMAT				= #P7

		#TM_IN_USE		= PARAMETER("LANGUAGE_NO")
		#SOP_ORDER_CYCLE_B	= PARAMETER("SOP_ORDER_CYCLE_B")

		PERFORM DESPATCH_PRINT_CONTROL
	END_BLOCK

END_FORM

PROCEDURE_FORM SHIPPING_BATCH_SETUP (#C,#C1,#I,#P1,#P2,#P3,#P4,#P5,#P6,#P7,#P8)

	BEGIN_BLOCK SETUP
		#COMPANY_CODE		= #C
		#COMPANY_NAME		= #C1
		#ID 			= #I
		#DIVISION		= #P1
		#SHIPPING_RUN_NUMBER	= #P2
		#SOP_LOAD_ID		= #P3
		#DESPATCH_NOTES 	= #P4
		#PREPRINTED 		= #P5
		#LANGUAGE_CODE 		= #P6
		#NATIVE_LANGUAGE_CODE 	= #P7
		#ACCESSIBLE_WAREHOUSES	= #P8

		#TM_IN_USE		= PARAMETER("LANGUAGE_YES")
		#SOP_ORDER_CYCLE_B	= PARAMETER("SOP_ORDER_CYCLE_B")

		PERFORM DESPATCH_PRINT_CONTROL

		PERFORM REPORT
	END_BLOCK

END_FORM


PROCEDURE_FORM DESPATCH_PRINT_CONTROL

	BEGIN_BLOCK DESPATCH_PRINT_CONTROL

		#YES 			= PARAMETER("LANGUAGE_YES")
		#NO 			= PARAMETER("LANGUAGE_NO")
		#SINGLE			= PARAMETER("IC_SINGLE_UOM_CONTROL")
		#DOCUMENT_NAME		= PARAMETER("DOC_DESPATCH")
		#LAST_LANGUAGE_CODE 	= "ZZZZZ"

		PERFORM GET_OUR_ADDRESS

		PERFORM "GEMLB:LB_REPORT_PRINT_CONTROL" &
			(#ID,#ID&"/1","","","",#R_NAME, &
			#REPORT_AUTO,#QUEUE,#FORM_TYPE,#COPIES,"","","")

		PERFORM "GEMLB:LB_REPORT_PRINT_CONTROL" &
			(#ID,#ID&"/2","","","",#R_NAME_MSDS_PORTRAIT, &
			#REPORT_AUTO_2,#QUEUE_2,#FORM_TYPE_2,#COPIES_2,"","","")

		PERFORM "GEMLB:LB_REPORT_PRINT_CONTROL" &
			(#ID,#ID&"/3","","","",#R_NAME_MSDS_LANDSCAPE,&
			#REPORT_AUTO_3,#QUEUE_3,#FORM_TYPE_3,#COPIES_3,"","","")

		PERFORM 'GEMSOP:SOP_L_MSDS' CREATE_PRINT_VT

		IF (#TM_IN_USE = #NO)
                       IF (#PREPRINTED)
                       	PERFORM DESPATCH_PRINT
                               IF (%STATUS <> %FAILURE)
                                       PERFORM UPDATE_PRINT_FLAG
                               END_IF
                       ELSE
                               PERFORM DESPATCH_PRINT_PLAIN
                               IF (%STATUS <> %FAILURE)
                               	PERFORM UPDATE_PRINT_FLAG
                               END_IF
               	END_IF
               	PERFORM SALES_INCREMENT_VERSION
		END_IF

		IF (#TM_IN_USE = #YES)
               	IF (#PREPRINTED)
	                	PERFORM SHIPPING_DESPATCH_PRINT
                               IF (%STATUS <> %FAILURE)
                                       PERFORM SHIPPING_UPDATE_PRINT_FLAG
                               END_IF
                       ELSE
                               PERFORM SHIPPING_DESPATCH_PRINT_PLAIN
                               IF (%STATUS <> %FAILURE)
                                       PERFORM SHIPPING_UPDATE_PRINT_FLAG
                               END_IF
                       END_IF
                       PERFORM SHIP_INCREMENT_VERSION
		END_IF

		IF (#REPORT_AUTO = #YES)
			FILES/NOQUERY/PRINT_ONLY/QUEUE=#QUEUE &
				/FORM_TYPE=#FORM_TYPE/COPIES=#COPIES #R_NAME

			IF (%STATUS = %FAILURE)
				IF (#CALL_MODE = #CALL_MODE_WS) 
					! "Failed to submit print job"
					PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
						("FIN", "P_57095", "", #ERR_WARN, 0, "", "", "", "", "")
				ELSE			
					MESSAGE/IDENTIFIER/BELL/WAIT P_57095
				END_IF
			END_IF
		END_IF

		IF (#MODULE <> PARAMETER("MODULE_AR"))
			IF (#MSDS_PORTRAIT_CREATED AND #REPORT_AUTO = #YES)

				FILES/NOQUERY/PRINT_ONLY/QUEUE=#QUEUE_2 &
					/FORM_TYPE=#FORM_TYPE_2/COPIES=#COPIES_2 &
						#R_NAME_MSDS_PORTRAIT

				IF (%STATUS = %FAILURE)
					IF (#CALL_MODE = #CALL_MODE_WS) 
						! "Failed to submit print job"
						PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
							("FIN", "P_57095", "", #ERR_WARN, &
							0, "", "", "", "", "")
					ELSE			
						MESSAGE/IDENTIFIER/BELL/WAIT P_57095
					END_IF
				END_IF
			END_IF

			IF (#MSDS_LANDSCAPE_CREATED AND #REPORT_AUTO = #YES)

				FILES/NOQUERY/PRINT_ONLY/QUEUE=#QUEUE_3 &
					/FORM_TYPE=#FORM_TYPE_3/COPIES=#COPIES_3 &
						#R_NAME_MSDS_LANDSCAPE

				IF (%STATUS = %FAILURE)
					IF (#CALL_MODE = #CALL_MODE_WS) 
						! "Failed to submit print job"
						PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
							("FIN", "P_57095", "", #ERR_WARN, &
							0, "", "", "", "", "")
					ELSE			
						MESSAGE/IDENTIFIER/BELL/WAIT P_57095
					END_IF
				END_IF
			END_IF
		END_IF

	END_BLOCK

END_FORM


REPORT_FORM DESPATCH_PRINT &
	! need a write lock on MSDS tables modified later on, therefore no read_only lock
	! leave lock as upgradable to a write...
	/WIDTH=132 &
	/OUTPUT=(#R_NAME) &
	/TABLE=DESPATCH_NOTES   &
	/LOCK=NONE &
	/WITH=COMPANY_CODE=#COMPANY_CODE &
	/WITH=DIVISION=#DIVISION &
	/WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=CONFIRM_DESPATCH=(PARAMETER("LANGUAGE_NO")) &
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
	/SELECTION="A AND B AND C AND D AND (E OR F OR G)"	&
	/SORTED_BY=(WAREHOUSE,CUSTOMER_NUMBER,DELIVERY_ADDRESS_CODE,DESPATCH_NOTE,DESPATCH_LINE,ORDER_NUMBER,PROMISED_DATE,PART_CODE) &
	/BREAK=DC_SETUP,,(DESPATCH_NOTES(WAREHOUSE)) &
	/BREAK=NEW_CUSTOMER,PRINT_MSDS, &
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=NEW_DEST_WAREHOUSE,, &
		(DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)) &
	/BREAK=NEW_DELIVERY_ADDRESS,, &
		(DESPATCH_NOTES(CUSTOMER_NUMBER) & DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)) &
	/BREAK=NEXT_PAGE,&
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=%LINES_AFTER=1, &
		(DESPATCH_NOTES(DESPATCH_LINE)) &
	/HEADING_FORM=HEADINGS_FORM &
	/COLUMN_HEADINGS=SKIP_LINE


	BEGIN_BLOCK CHECK_PRINT_HEADER_COMMENTS
		IF ((#HEADER_COMMENTS_PRINTED = #NO) AND (#HEADER_COMMENTS_TO_PRINT = #YES))
			PERFORM HEADER_COMMENTS_PRINT_CONTROL
			#HEADER_COMMENTS_PRINTED = #YES
		END_IF
	END_BLOCK

	OUTPUT_BLOCK DESPATCH_LINE /ROW=1 /COL=1 &
			/SOURCE=(DESPATCH_NOTES(DESPATCH_LINE))

	BEGIN_BLOCK GET_ORDER
		FIND IN SALES_ORDER_HEADERS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER)

		FIND IN SALES_ORDER_LINES &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER) &
			/WITH=ORDER_LINE_NUMBER=DESPATCH_NOTES(ORDER_LINE_NUMBER)
	END_BLOCK

	BEGIN_BLOCK GET_PART_DESC
		#PRODUCT_LANGUAGE = ""

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_NO")))
			#PART 			= MESSAGE("P_24163")
			#SALES_UNIT		= DESPATCH_NOTES(UNIT_SALES)
                       #SOP_NOMINATED  	= DESPATCH_NOTES(SOP_NOMINATED_UNIT)

			PERFORM GET_IN_DESPATCH_QTY (#SALES_UNIT, #SALES_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)

			#PACK_QTY_IN_DESPATCH	= ""
                       #PACK_UNIT		= ""
                       #OTHER_UNIT		= ""
                       #OTHER_QTY_IN_DESPATCH	= ""
		END_IF

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_YES")))
			#PART = DESPATCH_NOTES(PART_CODE)

			FIND IN PRODUCT_MASTER &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=PART_CODE=DESPATCH_NOTES(PART_CODE)

			#DESC1 			= PRODUCT_MASTER(PART_DESC_1)
			#DESC2 			= PRODUCT_MASTER(PART_DESC_2)
			#WAREHOUSED_FLAG	= PRODUCT_MASTER(WAREHOUSED_FLAG)
                       #PACKAGED 		= PRODUCT_MASTER(IC_PACKAGED_PRODUCT)
                       #SALES_UNIT		= DESPATCH_NOTES(UNIT_SALES)
                       #SOP_NOMINATED		= DESPATCH_NOTES(SOP_NOMINATED_UNIT)
                       #OTHER_UNIT		= DESPATCH_NOTES(IC_OTHER_INVENTORY_UNIT)
                       #PACK_UNIT		= DESPATCH_NOTES(IC_PACK_UNIT)
			PERFORM GET_IN_DESPATCH_QTY (#SALES_UNIT, #SALES_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#OTHER_UNIT, #OTHER_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#PACK_UNIT, #PACK_QTY_IN_DESPATCH)

			IF (#WAREHOUSED_FLAG = #NO)
                       	#PACK_QTY_IN_DESPATCH	= ""
                               #PACK_UNIT              = ""
                               #OTHER_UNIT             = ""
                               #OTHER_QTY_IN_DESPATCH  = ""
			END_IF

                       IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #NO)
                               #OTHER_UNIT             = ""
                               #OTHER_QTY_IN_DESPATCH	= ""
                               #MASK4                  = ""
                               #PACK_UNIT              = ""
                               #PACK_QTY_IN_DESPATCH   = ""
                               #MASK2                  = ""

                       ELSE_IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #YES)
                               #OTHER_UNIT             = ""
                               #OTHER_QTY_IN_DESPATCH  = ""
                               #MASK4                  = ""
               	END_IF
		END_IF

		IF (#SALES_UNIT = #PACK_UNIT)
                       #MASK2 				= ""
			#PACK_QTY_IN_DESPATCH 		= ""
			#PACK_UNIT 			= ""
		END_IF

		IF (#SALES_UNIT =#SOP_NOMINATED)
                       #SOP_NOMINATED 			= ""
                       #NOMINATED_QTY_IN_DESPATCH 	= ""
                       #MASK3 				= ""
		END_IF

               IF (#SALES_UNIT = #OTHER_UNIT)
                       #OTHER_UNIT 			= ""
                       #OTHER_QTY_IN_DESPATCH 		= ""
                       #MASK4 				= ""
               END_IF

               IF (#PACK_UNIT = #SOP_NOMINATED)
                       #SOP_NOMINATED 			= ""
                       #NOMINATED_QTY_IN_DESPATCH 	= ""
                       #MASK3 				= ""
               END_IF

               IF (#PACK_UNIT = #OTHER_UNIT)
                       #OTHER_UNIT 			= ""
                       #OTHER_QTY_IN_DESPATCH 		= ""
                       #MASK4 				= ""
               END_IF

               IF (#SOP_NOMINATED = #OTHER_UNIT)
                       #OTHER_UNIT 			= ""
                       #OTHER_QTY_IN_DESPATCH 		= ""
                       #MASK4 				= ""
               END_IF

	        PERFORM QUANTITY_UOM (#SALES_UNIT,#SALES_QTY_IN_DESPATCH,#MASK1, &
                                      #PACK_UNIT,#PACK_QTY_IN_DESPATCH,#MASK2, &
                                      #SOP_NOMINATED,#NOMINATED_QTY_IN_DESPATCH,#MASK3, &
                                      #OTHER_UNIT,#OTHER_QTY_IN_DESPATCH,#MASK4)

		IF (#PRINT_LANGUAGE <> #NATIVE_LANGUAGE_CODE)
			FIND IN SYS_PRODUCT_LANGUAGE &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
				/WITH=PART_CODE=#PART

			IF (%STATUS = %SUCCESS)
				#DESC1		 	= SYS_PRODUCT_LANGUAGE(PART_DESC_1)
				#DESC2		 	= SYS_PRODUCT_LANGUAGE(PART_DESC_2)
				#PRODUCT_LANGUAGE	= #YES
			END_IF
		END_IF
	END_BLOCK

	BEGIN_BLOCK PRODUCT_MSDS_REQD
		IF (#DESPATCH_MSDS_REQD)
			PERFORM 'GEMSOP:SOP_L_MSDS' REQD_FOR_PRODUCT ( &
					(#SOP_ORDER_CYCLE_B), &
					(#CUSTOMER_NUMBER), &
					(DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)), &
					(DESPATCH_NOTES(DESPATCH_NUMBER)), &
					(#DESPATCH_NOTE), &
					(DESPATCH_NOTES(PART_CODE)), &
					#PRODUCT_MSDS_REQD)
		ELSE
			#PRODUCT_MSDS_REQD = 0
		END_IF
	END_BLOCK

	OUTPUT_BLOCK PART_CODE /ROW=1 /COL=6 /LEN=25 &
			/SOURCE=(#PART)

	OUTPUT_BLOCK WAREHOUSE /ROW=1 /COL=32 &
			/SOURCE=(DESPATCH_NOTES(WAREHOUSE))

	OUTPUT_BLOCK IC_LOT_NUMBER /ROW=1 /COL=35 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_NUMBER))

	OUTPUT_BLOCK IC_LOT_SEQUENCE /ROW=1 /COL=51 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_SEQUENCE))

	OUTPUT_BLOCK PART_DESC /ROW=1 /COL=61 /LEN=30 &
			/SOURCE=(#DESC1) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK DESC_2 /ROW=2 /COL=61 /LEN=30 &
			/SOURCE=(#DESC2) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK ADD_DESC /ROW=3 /COL=61 /LEN=30 /HEIGHT=0 &
			/SOURCE=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)) &
			/HEADING="" &
	  		/USE_IF=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"" AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

	OUTPUT_BLOCK NONSTOCK_DESC /ROW=1 /COL=61 /LEN=30 /HEIGHT=0 &
			/SOURCE=(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) = PARAMETER("LANGUAGE_YES"))

	BEGIN_BLOCK CALCULATE_NEXT_ROW
 		IF (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))
			#DOC_LENGTH	= 0
			#ROW		= 3

			IF  (SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"")
				#DOC_LENGTH=(LEN(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION))/ &
					FIELD_O_LENGTH(SALES_ORDER_DETAIL_DESCRIPTION))
				#ROW=3 + #DOC_LENGTH
			END_IF
 		ELSE
			#DOC_LENGTH	= 0
			#ROW		= 1

 			IF  (DESPATCH_NOTES(NONSTOCK_DESCRIPTION) <> "")
				#DOC_LENGTH=(LEN(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) / &
						FIELD_O_LENGTH(DESPATCH_NOTES,NONSTOCK_DESCRIPTION))
				#ROW = 1 + #DOC_LENGTH
			END_IF
		END_IF
	END_BLOCK

	OUTPUT_BLOCK PART_DETAIL /ROW=(#ROW) /COL=51 /LEN=30 /HEIGHT=0 &
			/SOURCE_IF=(#PRODUCT_LANGUAGE = #YES),(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) &
			/SOURCE_IF=(#PRODUCT_LANGUAGE <> #YES),(PRODUCT_MASTER(SYS_PART_DETAIL)) &
			/HEADING="" &
 			/USE_IF=(DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

 	BEGIN_BLOCK ADJUST_ROW_COUNTER
		IF (DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) = PARAMETER("LANGUAGE_YES") AND &
		   (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))
			#DOC_LENGTH	= 0
			IF (#PRODUCT_LANGUAGE = #YES)
				IF  (SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(SYS_PRODUCT_LANGUAGE,SYS_PART_DETAIL))
				END_IF
			ELSE
				IF  (PRODUCT_MASTER(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(PRODUCT_MASTER(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(PRODUCT_MASTER,SYS_PART_DETAIL))
				END_IF
			END_IF
			#ROW = #ROW + #DOC_LENGTH
 		END_IF

		IF (#ROW < 3)
			#ROW = 3
		END_IF
	END_BLOCK

	OUTPUT_BLOCK ORDER_NUMBER /ROW=1 /COL=91 &
			/SOURCE=(DESPATCH_NOTES(ORDER_NUMBER))

	OUTPUT_BLOCK ORDER_LINE /ROW=1 /COL=101 &
			/SOURCE=(DESPATCH_NOTES(ORDER_LINE_NUMBER))

	OUTPUT_BLOCK CUST_PART_CODE /ROW=2 /COL=6 &
			/SOURCE=(SALES_ORDER_LINES(CUSTOMERS_PART_CODE)) &
			/HEADING=""

	OUTPUT_BLOCK BIN_LOCATION /ROW=2 /COL=105 &
			/PROMPT=(#PROMPT(019)) &
			/SOURCE=(DESPATCH_NOTES(BIN_LOCATION)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(BIN_LOCATION)<>""))

	OUTPUT_BLOCK MH_NUMBER /ROW=3 /COL=105 &
			/PROMPT=(#PROMPT(020)) &
			/SOURCE=(DESPATCH_NOTES(MH_NUMBER)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(MH_NUMBER)<>""))

	OUTPUT_BLOCK SYS_SHIPPING_DATE /ROW=(#ROW+1) /COL=17 /LEN=13 &
			/PROMPT=(#PROMPT(016))	&
			/HEADING=""	&
			/SOURCE=(DESPATCH_NOTES(SYS_SHIPPING_DATE)) &
			/OUTPUT_MASK=#DATE_MASK

	OUTPUT_BLOCK TARIFF /ROW=(#ROW+1) /COL=44 &
			/PROMPT=(#PROMPT(024)) &
			/SOURCE=(DESPATCH_NOTES(SYS_TARIFF_CODE)) &
			/HEADING="" &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK SHIP_METHOD /ROW=(#ROW+1) /COL=56 &
			/SOURCE=(DESPATCH_NOTES(SHIP_METHOD)) &
			/HEADING=""

	OUTPUT_BLOCK WEIGHT /ROW=(#ROW+1) /COL=84 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK WEIGHT_UOM /ROW=(#ROW+1) /COL=94 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME /ROW=(#ROW+1) /COL=100 &
			/SOURCE=(DESPATCH_NOTES(VOLUME)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME_UOM /ROW=(#ROW+1) /COL=112 &
			/SOURCE=(DESPATCH_NOTES(VOLUME_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK PROCESSED_IND /ROW=(#ROW+2) /COL=35 &
			/PROMPT=(#PROMPT(025)) &
			/SOURCE=(DESPATCH_NOTES(SYS_EC_PROCESSED_INDICATOR)) &
			/HEADING=""

	OUTPUT_BLOCK DELIVERY_INST /ROW=(#ROW+2) /COL=52 &
			/SOURCE=(DESPATCH_NOTES(DELIVERY_INSTRUCTIONS)) &
			/HEADING=""

	BEGIN_BLOCK CHARACTERISTICS
		IF (SALES_ORDER_LINES(ORDER_LINE_TYPE)=PARAMETER("LINE_TYPE_STOCK"))
			PERFORM CHARACTERISTICS
		END_IF
	END_BLOCK

	BEGIN_BLOCK CHECK_PRINT_LINE_COMMENTS
		IF ((DESPATCH_NOTES(ORDER_NUMBER) <> "") &
		AND (DESPATCH_NOTES(ORDER_LINE_NUMBER) > 0))
			FIND IN SOP_ORDER_LINE_COMMENTS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
				/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
				/WITH=ORDER_NUMBER = DESPATCH_NOTES(ORDER_NUMBER) &
				/WITH=ORDER_LINE_NUMBER = DESPATCH_NOTES(ORDER_LINE_NUMBER) &
				/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
				/WITH=SOP_COMMENT NOT MISSING

			IF (%STATUS = %SUCCESS)
				PERFORM PRINT_LINE_COMMENTS
			END_IF
		END_IF
	END_BLOCK

END_FORM


REPORT_FORM DESPATCH_PRINT_PLAIN &
	! need a write lock on MSDS tables modified later on, therefore no read_only lock
	! leave lock as upgradable to a write...
	/WIDTH=132 &
	/OUTPUT=(#R_NAME) &
	/LOCK=NONE &
	/TABLE=DESPATCH_NOTES &
	/WITH=A.COMPANY_CODE=#COMPANY_CODE &
	/WITH=A.DIVISION=#DIVISION &
	/WITH=A.DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=A.CONFIRM_DESPATCH=(PARAMETER("LANGUAGE_NO")) &
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
	/SELECTION="A AND B AND C AND D AND (E OR F OR G)"	&
	/SORTED_BY=(WAREHOUSE,CUSTOMER_NUMBER,DELIVERY_ADDRESS_CODE,DESPATCH_NOTE,DESPATCH_LINE,ORDER_NUMBER,PROMISED_DATE,PART_CODE) &
	/BREAK=DC_SETUP,,(DESPATCH_NOTES(WAREHOUSE)) &
	/BREAK=NEW_DEST_WAREHOUSE,, &
		(DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)) &
	/BREAK=NEW_CUSTOMER,PRINT_MSDS, &
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=NEW_DELIVERY_ADDRESS,, &
		(DESPATCH_NOTES(CUSTOMER_NUMBER) & DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)) &
	/BREAK=NEXT_PAGE,&
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=%LINES_AFTER=1, &
		(DESPATCH_NOTES(DESPATCH_LINE)) &
	/HEADING_FORM=HEADINGS_FORM

	BEGIN_BLOCK CHECK_PRINT_HEADER_COMMENTS
		IF ((#HEADER_COMMENTS_PRINTED = #NO) &
		AND (#HEADER_COMMENTS_TO_PRINT = #YES))
			PERFORM HEADER_COMMENTS_PRINT_CONTROL
			#HEADER_COMMENTS_PRINTED = #YES
		END_IF
	END_BLOCK

	OUTPUT_BLOCK DESPATCH_LINE /ROW=1 /COL=1 &
			/SOURCE=(DESPATCH_NOTES(DESPATCH_LINE)) &
			/HEADING=(#PROMPT(009))

	BEGIN_BLOCK GET_ORDER
		FIND IN SALES_ORDER_HEADERS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER)

		FIND IN SALES_ORDER_LINES &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER) &
			/WITH=ORDER_LINE_NUMBER=DESPATCH_NOTES(ORDER_LINE_NUMBER)
	END_BLOCK

	BEGIN_BLOCK GET_PART_DESC
		#PRODUCT_LANGUAGE = ""

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_NO")))
			#PART = MESSAGE("P_24163")
                       #SALES_UNIT		= DESPATCH_NOTES(UNIT_SALES)
                       #SOP_NOMINATED          = DESPATCH_NOTES(SOP_NOMINATED_UNIT)
			PERFORM GET_IN_DESPATCH_QTY (#SALES_UNIT, #SALES_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)

                       #PACK_QTY_IN_DESPATCH	= ""
                       #PACK_UNIT             	= ""
                       #OTHER_UNIT		= ""
                       #OTHER_QTY_IN_DESPATCH  = ""
		END_IF

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_YES")))
			#PART = DESPATCH_NOTES(PART_CODE)

			FIND IN PRODUCT_MASTER &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=PART_CODE=DESPATCH_NOTES(PART_CODE)

			#DESC1			= PRODUCT_MASTER(PART_DESC_1)
			#DESC2 			= PRODUCT_MASTER(PART_DESC_2)
			#WAREHOUSED_FLAG	= PRODUCT_MASTER(WAREHOUSED_FLAG)
                       #PACKAGED 		= PRODUCT_MASTER(IC_PACKAGED_PRODUCT)
                       #SALES_UNIT		= DESPATCH_NOTES(UNIT_SALES)
                       #SOP_NOMINATED		= DESPATCH_NOTES(SOP_NOMINATED_UNIT)
                       #OTHER_UNIT		= DESPATCH_NOTES(IC_OTHER_INVENTORY_UNIT)
                       #PACK_UNIT		= DESPATCH_NOTES(IC_PACK_UNIT)
			PERFORM GET_IN_DESPATCH_QTY (#SALES_UNIT, #SALES_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#OTHER_UNIT, #OTHER_QTY_IN_DESPATCH)
			PERFORM GET_IN_DESPATCH_QTY (#PACK_UNIT, #PACK_QTY_IN_DESPATCH)

			IF (#WAREHOUSED_FLAG = #NO)
				#PACK_QTY_IN_DESPATCH		= ""
                               #PACK_UNIT			= ""
                               #OTHER_UNIT			= ""
                               #OTHER_QTY_IN_DESPATCH		= ""
			END_IF

                       IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #NO)
                               #OTHER_UNIT                     = ""
                               #OTHER_QTY_IN_DESPATCH		= ""
                               #MASK4                          = ""
                               #PACK_UNIT                      = ""
                               #PACK_QTY_IN_DESPATCH           = ""
                               #MASK2                          = ""

                       ELSE_IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #YES)
                               #OTHER_UNIT                     = ""
                               #OTHER_QTY_IN_DESPATCH          = ""
                               #MASK4                          = ""
                       END_IF
               END_IF

		IF (#SALES_UNIT = #PACK_UNIT)
               	#MASK2 					= ""
			#PACK_QTY_IN_DESPATCH 			= ""
                       #PACK_UNIT 				= ""
		END_IF

               IF (#SALES_UNIT =#SOP_NOMINATED)
                       #SOP_NOMINATED 				= ""
                       #NOMINATED_QTY_IN_DESPATCH 		= ""
                       #MASK3 					= ""
		END_IF

		IF (#SALES_UNIT = #OTHER_UNIT)
                       #OTHER_UNIT 				= ""
                       #OTHER_QTY_IN_DESPATCH 			= ""
                       #MASK4 					= ""
               END_IF

               IF (#PACK_UNIT = #SOP_NOMINATED)
	        	#SOP_NOMINATED 				= ""
               	#NOMINATED_QTY_IN_DESPATCH 		= ""
                       #MASK3 					= ""
               END_IF

               IF (#PACK_UNIT = #OTHER_UNIT)
                       #OTHER_UNIT 				= ""
                       #OTHER_QTY_IN_DESPATCH 			= ""
                       #MASK4 					= ""
               END_IF

               IF (#SOP_NOMINATED = #OTHER_UNIT)
                       #OTHER_UNIT 				= ""
                       #OTHER_QTY_IN_DESPATCH 			= ""
                       #MASK4 					= ""
               END_IF

		PERFORM QUANTITY_UOM (#SALES_UNIT,#SALES_QTY_IN_DESPATCH,#MASK1, &
                                      #PACK_UNIT,#PACK_QTY_IN_DESPATCH,#MASK2, &
                                      #SOP_NOMINATED,#NOMINATED_QTY_IN_DESPATCH,#MASK3, &
                                      #OTHER_UNIT,#OTHER_QTY_IN_DESPATCH,#MASK4)

		IF (#PRINT_LANGUAGE <> #NATIVE_LANGUAGE_CODE)
			FIND IN SYS_PRODUCT_LANGUAGE &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
				/WITH=PART_CODE=#PART
			IF (%STATUS = %SUCCESS)
				#DESC1		 	= SYS_PRODUCT_LANGUAGE(PART_DESC_1)
				#DESC2		 	= SYS_PRODUCT_LANGUAGE(PART_DESC_2)
				#PRODUCT_LANGUAGE	= #YES
			END_IF
		END_IF
	END_BLOCK

	BEGIN_BLOCK PRODUCT_MSDS_REQD
		IF (#DESPATCH_MSDS_REQD)
			PERFORM 'GEMSOP:SOP_L_MSDS' REQD_FOR_PRODUCT( &
					(#SOP_ORDER_CYCLE_B), &
					(#CUSTOMER_NUMBER), &
					(DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)), &
					(DESPATCH_NOTES(DESPATCH_NUMBER)), &
					(#DESPATCH_NOTE), &
					(DESPATCH_NOTES(PART_CODE)), &
					#PRODUCT_MSDS_REQD)
		ELSE
			#PRODUCT_MSDS_REQD = 0
		END_IF
	END_BLOCK

	OUTPUT_BLOCK  /ROW=1 /COL=4 &
			/SOURCE=("*") &
			/USE_IF=(#PRODUCT_MSDS_REQD)



	OUTPUT_BLOCK PART_CODE /ROW=1 /COL=5 /LEN=25 &
			/SOURCE=(#PART) &
			/HEADING=(#PROMPT(010))

	OUTPUT_BLOCK WAREHOUSE /ROW=1 /COL=31 &
			/SOURCE=(DESPATCH_NOTES(WAREHOUSE)) &
			/HEADING=(#PROMPT(011))

	OUTPUT_BLOCK IC_LOT_NUMBER /ROW=1 /COL=34 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_NUMBER)) &
			/HEADING=(#PROMPT(012))

	OUTPUT_BLOCK IC_LOT_SEQUENCE /ROW=1 /COL=50 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_SEQUENCE)) &
			/HEADING=(#PROMPT(026))

	OUTPUT_BLOCK PART_DESC /ROW=1 /COL=57 /LEN=30 &
			/SOURCE=(#DESC1) &
			/HEADING=(#PROMPT(013)) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK DESC_2 /ROW=2 /COL=57 /LEN=30 &
			/SOURCE=(#DESC2) &
			/HEADING=""  &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK ADD_DESC /ROW=3 /COL=57 /LEN=30 /HEIGHT=0 &
			/SOURCE=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)) &
			/HEADING="" &
	  		/USE_IF=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"" AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

	OUTPUT_BLOCK NONSTOCK_DESC  /ROW=1 /COL=57 /LEN=30 /HEIGHT=0 &
			/SOURCE=(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) &
			/HEADING=(#PROMPT(013)) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) = PARAMETER("LANGUAGE_YES"))

	BEGIN_BLOCK CALCULATE_NEXT_ROW
		IF (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))
			#DOC_LENGTH	= 0
			#ROW		= 3

 			IF  (SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"")
				#DOC_LENGTH=(LEN(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION))/ &
						FIELD_O_LENGTH(SALES_ORDER_DETAIL_DESCRIPTION))
				#ROW = 3 + #DOC_LENGTH
			END_IF
		ELSE
			#DOC_LENGTH	= 0
			#ROW		= 1

 			IF  (DESPATCH_NOTES(NONSTOCK_DESCRIPTION) <> "")
				#DOC_LENGTH=(LEN(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) / &
						FIELD_O_LENGTH(DESPATCH_NOTES,NONSTOCK_DESCRIPTION))
				#ROW = 1 + #DOC_LENGTH
			END_IF
		END_IF
	END_BLOCK

	OUTPUT_BLOCK PART_DETAIL /ROW=(#ROW) /COL=51 /LEN=30 /HEIGHT=0 &
			/SOURCE_IF=(#PRODUCT_LANGUAGE = #YES),(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) &
			/SOURCE_IF=(#PRODUCT_LANGUAGE <> #YES),(PRODUCT_MASTER(SYS_PART_DETAIL)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

	BEGIN_BLOCK ADJUST_ROW_COUNTER
		IF (DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) = PARAMETER("LANGUAGE_YES") AND &
		   (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))
			#DOC_LENGTH	= 0
			IF (#PRODUCT_LANGUAGE = #YES)
				IF  (SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(SYS_PRODUCT_LANGUAGE,SYS_PART_DETAIL))
				END_IF
			ELSE
				IF  (PRODUCT_MASTER(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(PRODUCT_MASTER(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(PRODUCT_MASTER,SYS_PART_DETAIL))
				END_IF
			END_IF
			#ROW = #ROW + #DOC_LENGTH
 		END_IF

		IF (#ROW < 3)
			#ROW = 3
		END_IF
	END_BLOCK

	OUTPUT_BLOCK ORDER_NUMBER /ROW=1 /COL=88 &
			/SOURCE=(DESPATCH_NOTES(ORDER_NUMBER)) &
			/HEADING=(#PROMPT(014))

	OUTPUT_BLOCK ORDER_LINE /ROW=1 /COL=98 &
			/SOURCE=(DESPATCH_NOTES(ORDER_LINE_NUMBER)) &
			/LHEADING=(FIELD_HEADING(ORDER_LINE_NUMBER))

	BEGIN_BLOCK SALES_NONSTOCK

                IF (#MASK1 <> "")
                        #ROW1 = 1
                ELSE
                        #ROW1 = 0
                END_IF

		OUTPUT_BLOCK DESPATCH_QTY_12 /ROW=#ROW1 /COL=114 /LEN=14 &
	                        /RHEADING=(FIELD_HEADING(DESPATCH_QTY_ACTUAL)) &
                        	/SOURCE=(#SALES_QTY_IN_DESPATCH) &
                        	/OUTPUT_MASK=#MASK1 &
				/USE_IF=(#MASK1 <> "")

		OUTPUT_BLOCK DESPATCH_SALES_UOM /ROW=#ROW1 /COL=129 /LEN=4 &
                	        /SOURCE=(#SALES_UNIT) &
				/USE_IF=(#MASK1 <> "")

		IF (#MASK3="" AND #MASK2="" AND #MASK4="")
			GOTO CUST_PART_CODE
		END_IF

	END_BLOCK

	BEGIN_BLOCK DETERMINE_ROW2
                IF (#ROW1 = 0)
                        IF (#MASK2 <> "")
                                #ROW2 = 1
                        ELSE
                                #ROW2 = 0
                                GOTO DETERMINE_ROW3
                        END_IF
                ELSE
                        IF (#MASK2 <> "")
                                #ROW2 = 2
                        ELSE
                                #ROW2 = 1
                                GOTO DETERMINE_ROW3
                        END_IF
                END_IF

        	OUTPUT_BLOCK PACK_QTY /ROW=#ROW2 /COL=114 /LEN=14 &
                        /NOHEADING &
                        /SOURCE=(#PACK_QTY_IN_DESPATCH) &
                        /OUTPUT_MASK=#MASK2 &
                        /USE_IF=(#MASK2 <> "")

	        OUTPUT_BLOCK PACK_UNIT /ROW=#ROW2 /COL=129 /LEN=4 &
                        /SOURCE=(#PACK_UNIT) &
                        /USE_IF=(#MASK2 <> "") &

	END_BLOCK
	
	BEGIN_BLOCK DETERMINE_ROW3

	        IF (#ROW2 = 1)
                        IF (#MASK3 <> "")
                                #ROW3 = 2
                        ELSE
                                #ROW3 = 1
                                GOTO DETERMINE_ROW4
                        END_IF
                ELSE_IF (#ROW2 = 2)
                        IF (#MASK3 <> "")
                                #ROW3 = 3
                        ELSE
                                #ROW3 = 2
                                GOTO DETERMINE_ROW4
                        END_IF
                ELSE_IF (#ROW2 = 0)
                        IF (#MASK3 <> "")
                                #ROW3 = 1
                        ELSE
                                #ROW3 = 0
                                GOTO DETERMINE_ROW4
			END_IF
		END_IF

                        OUTPUT_BLOCK NOMINATED_QTY /ROW=#ROW3 /COL=114 /LEN=14 &
                                /SOURCE=(#NOMINATED_QTY_IN_DESPATCH) &
                                /OUTPUT_MASK=#MASK3 &
                                /USE_IF=(#MASK3 <> "")

                        OUTPUT_BLOCK NOMINATED_UNIT /ROW=#ROW3 /COL=129 /LEN=4 &
                                /SOURCE=(#SOP_NOMINATED) &
                                /USE_IF=(#MASK3 <> "")

	END_BLOCK

	BEGIN_BLOCK DETERMINE_ROW4

            IF (#ROW3 = 0)
                        IF (#MASK4 <> "")
                                #ROW4 = 1
                        END_IF
                ELSE_IF (#ROW3 = 1)
                        IF (#MASK4 <> "")
                                #ROW4 = 2
                        END_IF
                ELSE_IF (#ROW3 = 2)
                        IF (#MASK4 <> "")
                                #ROW4 = 3
                        END_IF
                ELSE_IF (#ROW3 = 3)
                        IF (#MASK4 <> "")
                                #ROW4 = 4
                        END_IF
                END_IF

                        OUTPUT_BLOCK OTHER_QTY3 /ROW=#ROW4 /COL=114 /LEN=14 &
                                /SOURCE=(#OTHER_QTY_IN_DESPATCH) &
                                /OUTPUT_MASK=#MASK4 &
	                       /USE_IF=(#MASK4 <> "")

                        OUTPUT_BLOCK OTHER_UNIT3 /ROW=#ROW4 /COL=129 /LEN=4 &
                                /SOURCE=(#OTHER_UNIT) &
                                /USE_IF=(#MASK4 <> "")

                        OUTPUT_BLOCK BLANK4 /ROW=5 /COL=1 &
                                /SOURCE=(" ")
	END_BLOCK

	OUTPUT_BLOCK CUST_PART_CODE /ROW=2 /COL=5 &
			/SOURCE=(SALES_ORDER_LINES(CUSTOMERS_PART_CODE)) &
			/HEADING=""

	OUTPUT_BLOCK BIN_LOCATION /ROW=3 /COL=35 &
			/PROMPT=(#PROMPT(019)) &
			/SOURCE=(DESPATCH_NOTES(BIN_LOCATION)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(BIN_LOCATION)<>""))

	OUTPUT_BLOCK MH_NUMBER /ROW=(#ROW) /COL=60 &
			/PROMPT=(#PROMPT(020)) &
			/SOURCE=(DESPATCH_NOTES(MH_NUMBER)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(MH_NUMBER)<>""))

	OUTPUT_BLOCK SYS_SHIPPING_DATE /ROW=(#ROW+1) /COL=17 /LEN=13 &
			/PROMPT=(#PROMPT(016))	&
			/HEADING=""	&
			/SOURCE=(DESPATCH_NOTES(SYS_SHIPPING_DATE)) &
			/OUTPUT_MASK=#DATE_MASK

	OUTPUT_BLOCK TARIFF /ROW=(#ROW+1) /COL=44 &
			/PROMPT=(#PROMPT(024)) &
			/SOURCE=(DESPATCH_NOTES(SYS_TARIFF_CODE)) &
			/HEADING="" &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK SHIP_METHOD /ROW=(#ROW+3) /COL=56 &
			/SOURCE=(DESPATCH_NOTES(SHIP_METHOD)) &
			/HEADING=""

	OUTPUT_BLOCK WEIGHT /ROW=(#ROW+3) /COL=84 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK WEIGHT_UOM /ROW=(#ROW+3) /COL=94 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME /ROW=(#ROW+3) /COL=100 &
			/SOURCE=(DESPATCH_NOTES(VOLUME)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME_UOM /ROW=(#ROW+3) /COL=112 &
			/SOURCE=(DESPATCH_NOTES(VOLUME_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK PROCESSED_IND /ROW=(#ROW+4) /COL=35 &
			/PROMPT=(#PROMPT(025)) &
			/SOURCE=(DESPATCH_NOTES(SYS_EC_PROCESSED_INDICATOR)) &
			/HEADING=""

	OUTPUT_BLOCK DELIVERY_INST /ROW=(#ROW+5) /COL=51 &
			/SOURCE=(DESPATCH_NOTES(DELIVERY_INSTRUCTIONS)) &
			/HEADING=""

	BEGIN_BLOCK CHARACTERISTICS
		IF (SALES_ORDER_LINES(ORDER_LINE_TYPE)=PARAMETER("LINE_TYPE_STOCK"))
			PERFORM CHARACTERISTICS
		END_IF
	END_BLOCK

	BEGIN_BLOCK CHECK_PRINT_LINE_COMMENTS
		IF ((DESPATCH_NOTES(ORDER_NUMBER) <> "") &
		AND (DESPATCH_NOTES(ORDER_LINE_NUMBER) > 0))
			FIND IN SOP_ORDER_LINE_COMMENTS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
				/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
				/WITH=ORDER_NUMBER = DESPATCH_NOTES(ORDER_NUMBER) &
				/WITH=ORDER_LINE_NUMBER = DESPATCH_NOTES(ORDER_LINE_NUMBER) &
				/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
				/WITH=SOP_COMMENT NOT MISSING

			IF (%STATUS = %SUCCESS)
				PERFORM PRINT_LINE_COMMENTS
			END_IF
		END_IF
	END_BLOCK

END_FORM


REPORT_FORM SHIPPING_DESPATCH_PRINT &
	! need a write lock on MSDS tables modified later on, therefore no read_only lock
	! leave lock as upgradable to a write...
	/WIDTH=132 &
	/OUTPUT=(#R_NAME) &
	/TABLE=DESPATCH_NOTES &
	/LOCK=NONE &
	/WITH=COMPANY_CODE=#COMPANY_CODE &
	/WITH=DIVISION=#DIVISION &
	/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER &
	/WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID &
	/WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=CONFIRM_DESPATCH = #NO	&
	/WITH=TM_LOAD_PLANNING = #YES	&
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
	/SELECTION="A AND B AND C AND D AND E AND F AND G AND (H OR I OR J)" &
	/SORTED_BY=(SOP_LOAD_ID, DESPATCH_NOTE, WAREHOUSE, DESPATCH_LINE, ORDER_NUMBER, PROMISED_DATE, PART_CODE) &
	/BREAK=NEW_LOAD,,(DESPATCH_NOTES(TM_LOAD_NUMBER)) &
	/BREAK=NEW_DEST_WAREHOUSE,, &
		(DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)) &
	/BREAK=NEW_CUSTOMER,PRINT_MSDS, &
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=NEW_DELIVERY_ADDRESS,, &
		(DESPATCH_NOTES(CUSTOMER_NUMBER) & DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)) &
	/BREAK=NEXT_PAGE,&
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=DC_SETUP,,(DESPATCH_NOTES(WAREHOUSE)) &
	/BREAK=%LINES_AFTER=1, &
		(DESPATCH_NOTES(DESPATCH_LINE)) &
	/BREAK=PRINT_ORDER_COMMENTS_REP,,DESPATCH_NOTES(ORDER_NUMBER) &
	/BREAK=PRINT_ORDER_LINE_COMMENTS,(DESPATCH_NOTES(ORDER_NUMBER)&DESPATCH_NOTES(ORDER_LINE_NUMBER)) &
	/HEADING_FORM=HEADINGS_FORM &
	/COLUMN_HEADINGS=SKIP_LINE


	BEGIN_BLOCK CHECK_PRINT_HEADER_COMMENTS
		IF ((#HEADER_COMMENTS_PRINTED = #NO) &
		AND (#HEADER_COMMENTS_TO_PRINT = #YES))
			PERFORM HEADER_COMMENTS_PRINT_CONTROL
			#HEADER_COMMENTS_PRINTED = #YES
		END_IF
	END_BLOCK

	OUTPUT_BLOCK DESPATCH_LINE /ROW=1 /COL=1 &
			/SOURCE=(DESPATCH_NOTES(DESPATCH_LINE))

	BEGIN_BLOCK GET_ORDER
		FIND IN SALES_ORDER_HEADERS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER)

		FIND IN SALES_ORDER_LINES &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER) &
			/WITH=ORDER_LINE_NUMBER=DESPATCH_NOTES(ORDER_LINE_NUMBER)
	END_BLOCK

	BEGIN_BLOCK GET_PART_DESC
		#PRODUCT_LANGUAGE = ""

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_NO")))
			#PART = MESSAGE("P_24163")
                        #SALES_UNIT                     = DESPATCH_NOTES(UNIT_SALES)
			PERFORM GET_IN_DESPATCH_QTY( #SALES_UNIT, #SALES_QTY_IN_DESPATCH)
                        #SOP_NOMINATED                  = DESPATCH_NOTES(SOP_NOMINATED_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)

                        #PACK_QTY_IN_DESPATCH           = ""
                        #PACK_UNIT                      = ""
                        #OTHER_UNIT                     = ""
                        #OTHER_QTY_IN_DESPATCH          = ""
		END_IF

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_YES")))
			#PART = DESPATCH_NOTES(PART_CODE)
			FIND IN PRODUCT_MASTER &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=PART_CODE=DESPATCH_NOTES(PART_CODE)

			#DESC1 		= PRODUCT_MASTER(PART_DESC_1)
			#DESC2 		= PRODUCT_MASTER(PART_DESC_2)
			#WAREHOUSED_FLAG= PRODUCT_MASTER(WAREHOUSED_FLAG)
                        #SALES_UNIT                     = DESPATCH_NOTES(UNIT_SALES)
			PERFORM GET_IN_DESPATCH_QTY( #SALES_UNIT, #SALES_QTY_IN_DESPATCH)
                        #SOP_NOMINATED                  = DESPATCH_NOTES(SOP_NOMINATED_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)
                        #OTHER_UNIT                     = DESPATCH_NOTES(IC_OTHER_INVENTORY_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #OTHER_UNIT, #OTHER_QTY_IN_DESPATCH)
                        #PACK_UNIT                      = DESPATCH_NOTES(IC_PACK_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #PACK_UNIT, #PACK_QTY_IN_DESPATCH)
			IF (#WAREHOUSED_FLAG = #NO)
                                #PACK_QTY_IN_DESPATCH            = ""
                                #PACK_UNIT                      = ""
                                #OTHER_UNIT                     = ""
                                #OTHER_QTY_IN_DESPATCH           = ""
			END_IF
                        IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #NO)
                                #OTHER_UNIT                     = ""
                                #OTHER_QTY_IN_DESPATCH          = ""
                                #MASK4                          = ""
                                #PACK_UNIT                      = ""
                                #PACK_QTY_IN_DESPATCH           = ""
                                #MASK2                          = ""

                        ELSE_IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #YES)
                                #OTHER_UNIT                     = ""
                                #OTHER_QTY_IN_DESPATCH          = ""
                                #MASK4                          = ""
                        END_IF
                END_IF

                IF (#SALES_UNIT = #PACK_UNIT)
                        #MASK2 = ""
			#PACK_QTY_IN_DESPATCH = ""
                        #PACK_UNIT = ""
		END_IF

                IF (#SALES_UNIT =#SOP_NOMINATED)
                        #SOP_NOMINATED = ""
                        #NOMINATED_QTY_IN_DESPATCH = ""
                        #MASK3 = ""
		END_IF

                IF (#SALES_UNIT = #OTHER_UNIT)
                        #OTHER_UNIT = ""
                        #OTHER_QTY_IN_DESPATCH = ""
                        #MASK4 = ""
                END_IF

                IF (#PACK_UNIT = #SOP_NOMINATED)
                        #SOP_NOMINATED = ""
                        #NOMINATED_QTY_IN_DESPATCH = ""
                        #MASK3 = ""
                END_IF

                IF (#PACK_UNIT = #OTHER_UNIT)
                        #OTHER_UNIT = ""
                        #OTHER_QTY_IN_DESPATCH = ""
                        #MASK4 = ""
                END_IF

                IF (#SOP_NOMINATED = #OTHER_UNIT)
                        #OTHER_UNIT = ""
                        #OTHER_QTY_IN_DESPATCH = ""
                        #MASK4 = ""
                END_IF

	        PERFORM QUANTITY_UOM (#SALES_UNIT,#SALES_QTY_IN_DESPATCH,#MASK1, &
                                      #PACK_UNIT,#PACK_QTY_IN_DESPATCH,#MASK2, &
                                      #SOP_NOMINATED,#NOMINATED_QTY_IN_DESPATCH,#MASK3, &
                                      #OTHER_UNIT,#OTHER_QTY_IN_DESPATCH,#MASK4)
		IF (#PRINT_LANGUAGE <> #NATIVE_LANGUAGE_CODE)
				FIND IN SYS_PRODUCT_LANGUAGE &
					/LOCK=NONE &
					/WITH=COMPANY_CODE=#COMPANY_CODE &
					/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
					/WITH=PART_CODE=#PART
				IF (%STATUS=%SUCCESS)
					#DESC1		 = SYS_PRODUCT_LANGUAGE(PART_DESC_1)
					#DESC2		 = SYS_PRODUCT_LANGUAGE(PART_DESC_2)
					#PRODUCT_LANGUAGE= #YES
				END_IF
		END_IF
	END_BLOCK

	BEGIN_BLOCK PRODUCT_MSDS_REQD
		IF (#DESPATCH_MSDS_REQD)
			PERFORM 'GEMSOP:SOP_L_MSDS' REQD_FOR_PRODUCT( &
					(#SOP_ORDER_CYCLE_B), &
					(#CUSTOMER_NUMBER), &
					(DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)), &
					(DESPATCH_NOTES(DESPATCH_NUMBER)), &
					(#DESPATCH_NOTE), &
					(DESPATCH_NOTES(PART_CODE)), &
					#PRODUCT_MSDS_REQD)
		ELSE
			#PRODUCT_MSDS_REQD = 0
		END_IF
	END_BLOCK

	OUTPUT_BLOCK  /ROW=1 /COL=4 &
			/SOURCE=("*") &
			/USE_IF=(#PRODUCT_MSDS_REQD)

	OUTPUT_BLOCK PART_CODE /ROW=1 /COL=6 /LEN=25 &
			/SOURCE=(#PART)

	OUTPUT_BLOCK WAREHOUSE /ROW=1 /COL=32 &
			/SOURCE=(DESPATCH_NOTES(WAREHOUSE))

	OUTPUT_BLOCK IC_LOT_NUMBER /ROW=1 /COL=35 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_NUMBER))

	OUTPUT_BLOCK IC_LOT_SEQUENCE /ROW=1 /COL=51 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_SEQUENCE)) &
			/USE_IF=(DESPATCH_NOTES(IC_LOT_SEQUENCE)<>'')

	OUTPUT_BLOCK PART_DESC /ROW=1 /COL=61 /LEN=30 &
			/SOURCE=(#DESC1) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK DESC_2 /ROW=2 /COL=61 /LEN=30 &
			/SOURCE=(#DESC2) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK ADD_DESC /ROW=3 /COL=61 /LEN=30 /HEIGHT=0 &
			/SOURCE=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)) &
			/HEADING="" &
	  		/USE_IF=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"" AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

	OUTPUT_BLOCK  NONSTOCK_DESC /ROW=1 /COL=61 /LEN=30 /HEIGHT=0 &
			/SOURCE=(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) = PARAMETER("LANGUAGE_YES"))

	BEGIN_BLOCK CALCULATE_NEXT_ROW
		IF (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))
 			#DOC_LENGTH	= 0
			#ROW		= 3

			IF  (SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"")
				#DOC_LENGTH=(LEN(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION))/ &
					FIELD_O_LENGTH(SALES_ORDER_DETAIL_DESCRIPTION))
				#ROW=3 + #DOC_LENGTH
			END_IF
		ELSE
			#DOC_LENGTH	= 0
			#ROW		= 1

 			IF  (DESPATCH_NOTES(NONSTOCK_DESCRIPTION) <> "")
				#DOC_LENGTH=(LEN(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) / &
						FIELD_O_LENGTH(DESPATCH_NOTES,NONSTOCK_DESCRIPTION))
				#ROW = 1 + #DOC_LENGTH
			END_IF
		END_IF
 	END_BLOCK

	OUTPUT_BLOCK PART_DETAIL /ROW=(#ROW) /COL=51 /LEN=30 /HEIGHT=0 &
			/SOURCE_IF=(#PRODUCT_LANGUAGE = #YES),(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) &
			/SOURCE_IF=(#PRODUCT_LANGUAGE <> #YES),(PRODUCT_MASTER(SYS_PART_DETAIL)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

 	BEGIN_BLOCK ADJUST_ROW_COUNTER
		IF (DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) = PARAMETER("LANGUAGE_YES") AND &
		   (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))
			#DOC_LENGTH	= 0
			IF (#PRODUCT_LANGUAGE = #YES)
				IF  (SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(SYS_PRODUCT_LANGUAGE,SYS_PART_DETAIL))
				END_IF
			ELSE
				IF  (PRODUCT_MASTER(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(PRODUCT_MASTER(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(PRODUCT_MASTER,SYS_PART_DETAIL))
				END_IF
			END_IF
			#ROW = #ROW + #DOC_LENGTH
 		END_IF

		IF (#ROW < 3)
			#ROW = 3
		END_IF
	END_BLOCK

	OUTPUT_BLOCK ORDER_NUMBER /ROW=1 /COL=91 &
			/SOURCE=(DESPATCH_NOTES(ORDER_NUMBER))

	OUTPUT_BLOCK ORDER_LINE /ROW=1 /COL=101 &
			/SOURCE=(DESPATCH_NOTES(ORDER_LINE_NUMBER))


 	BEGIN_BLOCK DETERMINE_ROW1

                IF (#MASK1 <> "")
                        #ROW1 = 1
                ELSE
                        #ROW1 = 0
                END_IF

		OUTPUT_BLOCK DESPATCH_QTY_12 /ROW=#ROW1 /COL=114 /LEN=14 &
				/RHEADING=(FIELD_HEADING(DESPATCH_QTY_ACTUAL)) &
                        	/SOURCE=(#SALES_QTY_IN_DESPATCH) &
                        	/OUTPUT_MASK=#MASK1 &
				/USE_IF=(#MASK1 <> "")

		OUTPUT_BLOCK DESPATCH_SALES_UOM /ROW=#ROW1 /COL=129 /LEN=4 &
                	        /SOURCE=(#SALES_UNIT) &
				/HEADING=FIELD_HEADING(UNIT_OF_MEASURE) &
				/USE_IF=(#MASK1 <> "")

		IF (#MASK3="" AND #MASK2="" AND #MASK4="")
			GOTO CUST_PART_CODE
		END_IF

	END_BLOCK

        BEGIN_BLOCK DETERMINE_ROW2
                IF (#ROW1 = 0)
                        IF (#MASK2 <> "")
                                #ROW2 = 1
                        ELSE
                                #ROW2 = 0
                                GOTO DETERMINE_ROW3
                        END_IF
                ELSE
                        IF (#MASK2 <> "")
                                #ROW2 = 2
                        ELSE
                                #ROW2 = 1
                                GOTO DETERMINE_ROW3
                        END_IF
                END_IF

	        OUTPUT_BLOCK PACK_QTY /ROW=#ROW2 /COL=114 /LEN=14 &
                        /NOHEADING &
                        /SOURCE=(#PACK_QTY_IN_DESPATCH) &
                        /OUTPUT_MASK=#MASK2 &
                        /USE_IF=(#MASK2 <> "")

        	OUTPUT_BLOCK PACK_UNIT /ROW=#ROW2 /COL=129 /LEN=4 &
                        /SOURCE=(#PACK_UNIT) &
                        /USE_IF=(#MASK2 <> "")
	END_BLOCK

        BEGIN_BLOCK DETERMINE_ROW3
              IF (#ROW2 = 1)
                        IF (#MASK3 <> "")
                                #ROW3 = 2
                        ELSE
                                #ROW3 = 1
                                GOTO DETERMINE_ROW
                        END_IF
                ELSE_IF (#ROW2 = 2)
                        IF (#MASK3 <> "")
                                #ROW3 = 3
                        ELSE
                                #ROW3 = 2
                                GOTO DETERMINE_ROW
                        END_IF
                ELSE_IF (#ROW2 = 0)
                        IF (#MASK3 <> "")
                                #ROW3 = 1
                        ELSE
                                #ROW3 = 0
                                GOTO DETERMINE_ROW
			END_IF
		END_IF

                OUTPUT_BLOCK NOMINATED_QTY /ROW=#ROW3 /COL=114 /LEN=14 &
                                /SOURCE=(#NOMINATED_QTY_IN_DESPATCH) &
                                /OUTPUT_MASK=#MASK3 &
                                /USE_IF=(#MASK3 <> "")

                OUTPUT_BLOCK NOMINATED_UNIT /ROW=#ROW3 /COL=129 /LEN=4 &
                                /SOURCE=(#SOP_NOMINATED) &
                                /USE_IF=(#MASK3 <> "")
	END_BLOCK

	BEGIN_BLOCK DETERMINE_ROW
		IF (#ROW3 = 0)
                        IF (#MASK4 <> "")
                                #ROW4 = 1
                        END_IF
                ELSE_IF (#ROW3 = 1)
                        IF (#MASK4 <> "")
                                #ROW4 = 2
                        END_IF
                ELSE_IF (#ROW3 = 2)
                        IF (#MASK4 <> "")
                                #ROW4 = 3
                        END_IF
                ELSE_IF (#ROW3 = 3)
                        IF (#MASK4 <> "")
                                #ROW4 = 4
                        END_IF
                END_IF

                OUTPUT_BLOCK OTHER_QTY3 /ROW=#ROW4 /COL=114 /LEN=14 &
                                /SOURCE=(#OTHER_QTY_IN_DESPATCH) &
                                /OUTPUT_MASK=#MASK4 &
	                       /USE_IF=(#MASK4 <> "")

                 OUTPUT_BLOCK OTHER_UNIT3 /ROW=#ROW4 /COL=129 /LEN=4 &
                                /SOURCE=(#OTHER_UNIT) &
                                /USE_IF=(#MASK4 <> "")

                 OUTPUT_BLOCK BLANK4 /ROW=5 /COL=1 &
                                /SOURCE=(" ")
	END_BLOCK

	OUTPUT_BLOCK SYS_SHIPPING_DATE /ROW=(#ROW+1) /COL=17 /LEN=13 &
			/PROMPT=(#PROMPT(016))	&
			/HEADING=""	&
			/SOURCE=(DESPATCH_NOTES(SYS_SHIPPING_DATE)) &
			/OUTPUT_MASK=#DATE_MASK

	OUTPUT_BLOCK CUST_PART_CODE /ROW=2 /COL=6 &
			/SOURCE=(SALES_ORDER_LINES(CUSTOMERS_PART_CODE)) &
			/HEADING=""

	OUTPUT_BLOCK BIN_LOCATION /ROW=2 /COL=105 &
			/PROMPT=(#PROMPT(019)) &
			/SOURCE=(DESPATCH_NOTES(BIN_LOCATION)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(BIN_LOCATION)<>""))

	OUTPUT_BLOCK MH_NUMBER /ROW=3 /COL=105 &
			/PROMPT=(#PROMPT(020)) &
			/SOURCE=(DESPATCH_NOTES(MH_NUMBER)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(MH_NUMBER)<>""))

	OUTPUT_BLOCK TARIFF /ROW=(#ROW+1) /COL=44 &
			/PROMPT=(#PROMPT(024)) &
			/SOURCE=(DESPATCH_NOTES(SYS_TARIFF_CODE)) &
			/HEADING="" &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK SHIP_METHOD /ROW=(#ROW+1) /COL=56 &
			/SOURCE=(DESPATCH_NOTES(SHIP_METHOD)) &
			/HEADING=""

	OUTPUT_BLOCK WEIGHT /ROW=(#ROW+1) /COL=83 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK WEIGHT_UOM /ROW=(#ROW+1) /COL=94 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME /ROW=(#ROW+1) /COL=100 &
			/SOURCE=(DESPATCH_NOTES(VOLUME)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME_UOM /ROW=(#ROW+1) /COL=112 &
			/SOURCE=(DESPATCH_NOTES(VOLUME_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK PROCESSED_IND /ROW=(#ROW+2) /COL=35 &
			/PROMPT=(#PROMPT(025)) &
			/SOURCE=(DESPATCH_NOTES(SYS_EC_PROCESSED_INDICATOR)) &
			/HEADING="" &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK DELIVERY_INST /ROW=(#ROW+2) /COL=52 &
			/SOURCE=(DESPATCH_NOTES(DELIVERY_INSTRUCTIONS)) &
			/HEADING=""

	BEGIN_BLOCK CHARACTERISTICS
		IF (SALES_ORDER_LINES(ORDER_LINE_TYPE)=PARAMETER("LINE_TYPE_STOCK"))
			PERFORM CHARACTERISTICS
		END_IF
	END_BLOCK

	BEGIN_BLOCK CHECK_PRINT_LINE_COMMENTS
		IF ((DESPATCH_NOTES(ORDER_NUMBER) <> "") &
		AND (DESPATCH_NOTES(ORDER_LINE_NUMBER) > 0))
			FIND IN SOP_ORDER_LINE_COMMENTS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
				/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
				/WITH=ORDER_NUMBER = DESPATCH_NOTES(ORDER_NUMBER) &
				/WITH=ORDER_LINE_NUMBER = DESPATCH_NOTES(ORDER_LINE_NUMBER) &
				/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
				/WITH=SOP_COMMENT NOT MISSING

			IF (%STATUS = %SUCCESS)
				PERFORM PRINT_LINE_COMMENTS
			END_IF
		END_IF
	END_BLOCK

END_FORM


REPORT_FORM SHIPPING_DESPATCH_PRINT_PLAIN &
	! need a write lock on MSDS tables modified later on, therefore no read_only lock
	! leave lock as upgradable to a write...
	/WIDTH=132 &
	/OUTPUT=(#R_NAME) &
	/TABLE=DESPATCH_NOTES &
	/LOCK=NONE &
	/WITH=COMPANY_CODE=#COMPANY_CODE &
	/WITH=DIVISION=#DIVISION &
	/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER &
	/WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID	&
	/WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=CONFIRM_DESPATCH=#NO	&
	/WITH=TM_LOAD_PLANNING = #YES	&
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
!	/SELECTION="A AND B AND C AND D AND E AND F AND G AND H AND I AND J AND (K OR L OR M)" &
	/SELECTION="A AND B AND C AND D AND E AND F AND G AND (H OR I OR J)" &
	/SORTED_BY=(SOP_LOAD_ID, DESPATCH_NOTE, WAREHOUSE, DESPATCH_LINE, ORDER_NUMBER, PROMISED_DATE, PART_CODE) &
	/BREAK=NEW_LOAD,,(DESPATCH_NOTES(TM_LOAD_NUMBER)) &
	/BREAK=NEW_DEST_WAREHOUSE,, &
		(DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)) &
	/BREAK=NEW_CUSTOMER,PRINT_MSDS, &
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=NEW_DELIVERY_ADDRESS,, &
		(DESPATCH_NOTES(CUSTOMER_NUMBER) & DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)) &
	/BREAK=NEXT_PAGE,&
		(DESPATCH_NOTES(DESPATCH_NOTE)) &
	/BREAK=DC_SETUP,,(DESPATCH_NOTES(WAREHOUSE)) &
	/BREAK=PRINT_ORDER_COMMENTS_REP,,DESPATCH_NOTES(ORDER_NUMBER) &
	/BREAK=PRINT_ORDER_LINE_COMMENTS,(DESPATCH_NOTES(ORDER_NUMBER)&DESPATCH_NOTES(ORDER_LINE_NUMBER)) &
	/BREAK=%LINES_AFTER=1, &
		(DESPATCH_NOTES(DESPATCH_LINE)) &
	/HEADING_FORM=HEADINGS_FORM


	BEGIN_BLOCK CHECK_PRINT_HEADER_COMMENTS
		IF ((#HEADER_COMMENTS_PRINTED = #NO) &
		AND (#HEADER_COMMENTS_TO_PRINT = #YES))
			PERFORM HEADER_COMMENTS_PRINT_CONTROL
			#HEADER_COMMENTS_PRINTED = #YES
		END_IF
	END_BLOCK

	OUTPUT_BLOCK DESPATCH_LINE_1 /ROW=1 /COL=1 &
			/SOURCE=(DESPATCH_NOTES(DESPATCH_LINE)) &
			/HEADING=(#PROMPT(009))

	BEGIN_BLOCK GET_ORDER_1
		FIND IN SALES_ORDER_HEADERS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER)

		FIND IN SALES_ORDER_LINES &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=DIVISION=#DIVISION &
			/WITH=ORDER_NUMBER=DESPATCH_NOTES(ORDER_NUMBER) &
			/WITH=ORDER_LINE_NUMBER=DESPATCH_NOTES(ORDER_LINE_NUMBER)
	END_BLOCK

	BEGIN_BLOCK GET_PART_DESC
		#PRODUCT_LANGUAGE = ""

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_NO")))
			#PART = MESSAGE("P_24163")
                        #SALES_UNIT                     = DESPATCH_NOTES(UNIT_SALES)
			PERFORM GET_IN_DESPATCH_QTY( #SALES_UNIT, #SALES_QTY_IN_DESPATCH)
                        #SOP_NOMINATED                  = DESPATCH_NOTES(SOP_NOMINATED_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)

                        #PACK_QTY_IN_DESPATCH           = ""
                        #PACK_UNIT                      = ""
                        #OTHER_UNIT                     = ""
                        #OTHER_QTY_IN_DESPATCH          = ""
		END_IF

		IF (DESPATCH_NOTES(NONSTOCK) <> (PARAMETER("LANGUAGE_YES")))
			#PART = DESPATCH_NOTES(PART_CODE)

			FIND IN PRODUCT_MASTER &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=PART_CODE=DESPATCH_NOTES(PART_CODE)

			#DESC1 		= PRODUCT_MASTER(PART_DESC_1)
			#DESC2 		= PRODUCT_MASTER(PART_DESC_2)
			#WAREHOUSED_FLAG= PRODUCT_MASTER(WAREHOUSED_FLAG)
                        #PACKAGED = PRODUCT_MASTER(IC_PACKAGED_PRODUCT)
                        #SALES_UNIT                     = DESPATCH_NOTES(UNIT_SALES)
			PERFORM GET_IN_DESPATCH_QTY( #SALES_UNIT, #SALES_QTY_IN_DESPATCH)
                        #SOP_NOMINATED                  = DESPATCH_NOTES(SOP_NOMINATED_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #SOP_NOMINATED, #NOMINATED_QTY_IN_DESPATCH)
                        #OTHER_UNIT                     = DESPATCH_NOTES(IC_OTHER_INVENTORY_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #OTHER_UNIT, #OTHER_QTY_IN_DESPATCH)
                        #PACK_UNIT                      = DESPATCH_NOTES(IC_PACK_UNIT)
			PERFORM GET_IN_DESPATCH_QTY( #PACK_UNIT, #PACK_QTY_IN_DESPATCH)

			IF (#WAREHOUSED_FLAG = #NO)
                                #PACK_QTY_IN_DESPATCH            = ""
                                #PACK_UNIT                      = ""
                                #OTHER_UNIT                     = ""
                                #OTHER_QTY_IN_DESPATCH           = ""
			END_IF

                        IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #NO)
                                #OTHER_UNIT                     = ""
                                #OTHER_QTY_IN_DESPATCH          = ""
                                #MASK4                          = ""
                                #PACK_UNIT                      = ""
                                #PACK_QTY_IN_DESPATCH           = ""
                                #MASK2                          = ""

                        ELSE_IF (PRODUCT_MASTER(IC_PRODUCT_UOM_CONTROL) = #SINGLE AND #PACKAGED = #YES)
                                #OTHER_UNIT                     = ""
                                #OTHER_QTY_IN_DESPATCH          = ""
                                #MASK4                          = ""
                        END_IF
                END_IF

                IF (#SALES_UNIT = #PACK_UNIT)
                        #MASK2 = ""
			#PACK_QTY_IN_DESPATCH = ""
                        #PACK_UNIT = ""
		END_IF

                IF (#SALES_UNIT =#SOP_NOMINATED)
                        #SOP_NOMINATED = ""
                        #NOMINATED_QTY_IN_DESPATCH = ""
                        #MASK3 = ""
		END_IF

                IF (#SALES_UNIT = #OTHER_UNIT)
                        #OTHER_UNIT = ""
                        #OTHER_QTY_IN_DESPATCH = ""
                        #MASK4 = ""
                END_IF

                IF (#PACK_UNIT = #SOP_NOMINATED)
                        #SOP_NOMINATED = ""
                        #NOMINATED_QTY_IN_DESPATCH = ""
                        #MASK3 = ""
                END_IF

                IF (#PACK_UNIT = #OTHER_UNIT)
                        #OTHER_UNIT = ""
                        #OTHER_QTY_IN_DESPATCH = ""
                        #MASK4 = ""
                END_IF

                IF (#SOP_NOMINATED = #OTHER_UNIT)
                        #OTHER_UNIT = ""
                        #OTHER_QTY_IN_DESPATCH = ""
                        #MASK4 = ""
                END_IF

		PERFORM QUANTITY_UOM (#SALES_UNIT,#SALES_QTY_IN_DESPATCH,#MASK1, &
                                      #PACK_UNIT,#PACK_QTY_IN_DESPATCH,#MASK2, &
                                      #SOP_NOMINATED,#NOMINATED_QTY_IN_DESPATCH,#MASK3, &
                                      #OTHER_UNIT,#OTHER_QTY_IN_DESPATCH,#MASK4)

		IF (#PRINT_LANGUAGE <> #NATIVE_LANGUAGE_CODE)
				FIND IN SYS_PRODUCT_LANGUAGE &
					/LOCK=NONE &
					/WITH=COMPANY_CODE=#COMPANY_CODE &
					/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
					/WITH=PART_CODE=#PART
				IF (%STATUS = %SUCCESS)
					#DESC1		 = SYS_PRODUCT_LANGUAGE(PART_DESC_1)
					#DESC2		 = SYS_PRODUCT_LANGUAGE(PART_DESC_2)
					#PRODUCT_LANGUAGE= #YES
				END_IF
			END_IF
	END_BLOCK

	BEGIN_BLOCK PRODUCT_MSDS_REQD
		IF (#DESPATCH_MSDS_REQD)
			PERFORM 'GEMSOP:SOP_L_MSDS' REQD_FOR_PRODUCT( &
					(#SOP_ORDER_CYCLE_B), &
					(#CUSTOMER_NUMBER), &
					(DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)), &
					(DESPATCH_NOTES(DESPATCH_NUMBER)), &
					(#DESPATCH_NOTE), &
					(DESPATCH_NOTES(PART_CODE)), &
					#PRODUCT_MSDS_REQD)
		ELSE
			#PRODUCT_MSDS_REQD = 0
		END_IF
	END_BLOCK

	OUTPUT_BLOCK  /ROW=1 /COL=4 &
			/SOURCE=("*") &
			/USE_IF=(#PRODUCT_MSDS_REQD)

	OUTPUT_BLOCK PART_CODE /ROW=1 /COL=6 /LEN=25 &
			/SOURCE=(#PART) &
			/HEADING=(#PROMPT(010))

	OUTPUT_BLOCK WAREHOUSE /ROW=1 /COL=32 &
			/SOURCE=(DESPATCH_NOTES(WAREHOUSE)) &
			/HEADING=(#PROMPT(011))

	OUTPUT_BLOCK IC_LOT_NUMBER /ROW=1 /COL=35 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_NUMBER)) &
			/HEADING=(#PROMPT(012))

	OUTPUT_BLOCK IC_LOT_SEQUENCE /ROW=1 /COL=51 &
			/SOURCE=(DESPATCH_NOTES(IC_LOT_SEQUENCE)) &
			/HEADING=(#PROMPT(026)) &
			/USE_IF=(DESPATCH_NOTES(IC_LOT_SEQUENCE)<>'')

	OUTPUT_BLOCK PART_DESC /ROW=1 /COL=60 /LEN=30 &
			/SOURCE=(#DESC1) &
			/HEADING=(#PROMPT(013)) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK DESC_2 /ROW=2 /COL=60 /LEN=30 &
			/SOURCE=(#DESC2) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))

	OUTPUT_BLOCK ADD_DESC /ROW=3 /COL=60 /LEN=30 /HEIGHT=0 &
			/SOURCE=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)) &
			/HEADING="" &
	  		/USE_IF=(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"" AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

	OUTPUT_BLOCK  NONSTOCK_DESC /ROW=1 /COL=60 /LEN=30 /HEIGHT=0 &
			/SOURCE=(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) &
			/HEADING=(#PROMPT(013)) &
			/USE_IF=(DESPATCH_NOTES(NONSTOCK) = PARAMETER("LANGUAGE_YES"))

	BEGIN_BLOCK CALCULATE_NEXT_ROW
		IF (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES"))
			#DOC_LENGTH	= 0
			#ROW		= 3

			IF  (SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION)<>"")
				#DOC_LENGTH=(LEN(SALES_ORDER_LINES(SALES_ORDER_DETAIL_DESCRIPTION))/ &
						FIELD_O_LENGTH(SALES_ORDER_DETAIL_DESCRIPTION))
				#ROW = 3 + #DOC_LENGTH
			END_IF
		ELSE
			#DOC_LENGTH	= 0
			#ROW		= 1

 			IF  (DESPATCH_NOTES(NONSTOCK_DESCRIPTION) <> "")
				#DOC_LENGTH=(LEN(DESPATCH_NOTES(NONSTOCK_DESCRIPTION)) / &
						FIELD_O_LENGTH(DESPATCH_NOTES,NONSTOCK_DESCRIPTION))
				#ROW = 1 + #DOC_LENGTH
			END_IF
		END_IF
	END_BLOCK

	OUTPUT_BLOCK PART_DETAIL /ROW=(#ROW) /COL=51 /LEN=30 /HEIGHT=0 &
			/SOURCE_IF=(#PRODUCT_LANGUAGE = #YES),(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) &
			/SOURCE_IF=(#PRODUCT_LANGUAGE <> #YES),(PRODUCT_MASTER(SYS_PART_DETAIL)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) AND &
				(DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))

	BEGIN_BLOCK ADJUST_ROW_COUNTER
		IF (DESPATCH_NOTES(SYS_PRINT_PART_DETAIL) = PARAMETER("LANGUAGE_YES") AND &
		   (DESPATCH_NOTES(NONSTOCK) <> PARAMETER("LANGUAGE_YES")))
			#DOC_LENGTH	= 0
			IF (#PRODUCT_LANGUAGE = #YES)
				IF  (SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(SYS_PRODUCT_LANGUAGE(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(SYS_PRODUCT_LANGUAGE,SYS_PART_DETAIL))
				END_IF
			ELSE
				IF  (PRODUCT_MASTER(SYS_PART_DETAIL) <> "")
					#DOC_LENGTH=(LEN(PRODUCT_MASTER(SYS_PART_DETAIL)) / &
							FIELD_O_LENGTH(PRODUCT_MASTER,SYS_PART_DETAIL))
				END_IF
			END_IF
			#ROW = #ROW + #DOC_LENGTH
 		END_IF

		IF (#ROW < 3)
			#ROW = 3
		END_IF
	END_BLOCK

	OUTPUT_BLOCK ORDER_NUMBER /ROW=1 /COL=91 &
			/SOURCE=(DESPATCH_NOTES(ORDER_NUMBER)) &
			/HEADING=(#PROMPT(014))

	OUTPUT_BLOCK ORDER_LINE /ROW=1 /COL=101 &
			/SOURCE=(DESPATCH_NOTES(ORDER_LINE_NUMBER)) &
			/LHEADING=(#PROMPT(015))

	OUTPUT_BLOCK SYS_SHIPPING_DATE /ROW=4 /COL=17 /LEN=13 &
			/PROMPT=(#PROMPT(016))	&
			/HEADING=""	&
			/SOURCE=(DESPATCH_NOTES(SYS_SHIPPING_DATE)) &
			/OUTPUT_MASK=#DATE_MASK

      BEGIN_BLOCK SALES_NONSTOCK

                IF (#MASK1 <> "")
                        #ROW1 = 1
                ELSE
                        #ROW1 = 0
                END_IF

		OUTPUT_BLOCK DESPATCH_QTY_12 /ROW=#ROW1 /COL=114 /LEN=14 &
	                        /RHEADING=(FIELD_HEADING(DESPATCH_QTY_ACTUAL)) &
                        	/SOURCE=(#SALES_QTY_IN_DESPATCH) &
                        	/OUTPUT_MASK=#MASK1 &
				/USE_IF=(#MASK1 <> "")

		OUTPUT_BLOCK DESPATCH_SALES_UOM /ROW=#ROW1 /COL=129 /LEN=4 &
                	        /SOURCE=(#SALES_UNIT) &
				/USE_IF=(#MASK1 <> "")

		IF (#MASK3="" AND #MASK2="" AND #MASK4="")
			GOTO CUST_PART_CODE
		END_IF

	END_BLOCK

	BEGIN_BLOCK DETERMINE_ROW2
                IF (#ROW1 = 0)
                        IF (#MASK2 <> "")
                                #ROW2 = 1
                        ELSE
                                #ROW2 = 0
                                GOTO DETERMINE_ROW3
                        END_IF
                ELSE
                        IF (#MASK2 <> "")
                                #ROW2 = 2
                        ELSE
                                #ROW2 = 1
                                GOTO DETERMINE_ROW3
                        END_IF
                END_IF

        	OUTPUT_BLOCK PACK_QTY /ROW=#ROW2 /COL=114 /LEN=14 &
                        /NOHEADING &
                        /SOURCE=(#PACK_QTY_IN_DESPATCH) &
                        /OUTPUT_MASK=#MASK2 &
                        /USE_IF=(#MASK2 <> "")

	        OUTPUT_BLOCK PACK_UNIT /ROW=#ROW2 /COL=129 /LEN=4 &
                        /SOURCE=(#PACK_UNIT) &
                        /USE_IF=(#MASK2 <> "") &

	END_BLOCK

        BEGIN_BLOCK DETERMINE_ROW3


	        IF (#ROW2 = 1)
                        IF (#MASK3 <> "")
                                #ROW3 = 2
                        ELSE
                                #ROW3 = 1
                                GOTO DETERMINE_ROW4
                        END_IF
                ELSE_IF (#ROW2 = 2)
                        IF (#MASK3 <> "")
                                #ROW3 = 3
                        ELSE
                                #ROW3 = 2
                                GOTO DETERMINE_ROW4
                        END_IF
                ELSE_IF (#ROW2 = 0)
                        IF (#MASK3 <> "")
                                #ROW3 = 1
                        ELSE
                                #ROW3 = 0
                                GOTO DETERMINE_ROW4
			END_IF
		END_IF

                        OUTPUT_BLOCK NOMINATED_QTY /ROW=#ROW3 /COL=114 /LEN=14 &
                                /SOURCE=(#NOMINATED_QTY_IN_DESPATCH) &
                                /OUTPUT_MASK=#MASK3 &
                                /USE_IF=(#MASK3 <> "")

                        OUTPUT_BLOCK NOMINATED_UNIT /ROW=#ROW3 /COL=129 /LEN=4 &
                                /SOURCE=(#SOP_NOMINATED) &
                                /USE_IF=(#MASK3 <> "")

	END_BLOCK

	BEGIN_BLOCK DETERMINE_ROW4

            IF (#ROW3 = 0)
                        IF (#MASK4 <> "")
                                #ROW4 = 1
                        END_IF
                ELSE_IF (#ROW3 = 1)
                        IF (#MASK4 <> "")
                                #ROW4 = 2
                        END_IF
                ELSE_IF (#ROW3 = 2)
                        IF (#MASK4 <> "")
                                #ROW4 = 3
                        END_IF
                ELSE_IF (#ROW3 = 3)
                        IF (#MASK4 <> "")
                                #ROW4 = 4
                        END_IF
                END_IF

                        OUTPUT_BLOCK OTHER_QTY3 /ROW=#ROW4 /COL=114 /LEN=14 &
                                /SOURCE=(#OTHER_QTY_IN_DESPATCH) &
                                /OUTPUT_MASK=#MASK4 &
	                       /USE_IF=(#MASK4 <> "")

                        OUTPUT_BLOCK OTHER_UNIT3 /ROW=#ROW4 /COL=129 /LEN=4 &
                                /SOURCE=(#OTHER_UNIT) &
                                /USE_IF=(#MASK4 <> "")

                        OUTPUT_BLOCK BLANK4 /ROW=5 /COL=1 &
                                /SOURCE=(" ")
	END_BLOCK

	OUTPUT_BLOCK CUST_PART_CODE /ROW=2 /COL=6 &
			/SOURCE=(SALES_ORDER_LINES(CUSTOMERS_PART_CODE)) &
			/HEADING=""

	OUTPUT_BLOCK BIN_LOCATION /ROW=2 /COL=107 &
			/PROMPT=(#PROMPT(019)) &
			/SOURCE=(DESPATCH_NOTES(BIN_LOCATION)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(BIN_LOCATION)<>""))

	OUTPUT_BLOCK MH_NUMBER /ROW=3 /COL=107 &
			/PROMPT=(#PROMPT(020)) &
			/SOURCE=(DESPATCH_NOTES(MH_NUMBER)) &
			/HEADING="" &
			/USE_IF=(#PICK = #NO AND (DESPATCH_NOTES(MH_NUMBER)<>""))

	OUTPUT_BLOCK TARIFF /ROW=(#ROW+1) /COL=44 &
			/PROMPT=(#PROMPT(024)) &
			/SOURCE=(DESPATCH_NOTES(SYS_TARIFF_CODE)) &
			/HEADING="" &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK SHIP_METHOD /ROW=(#ROW+1) /COL=56 &
			/SOURCE=(DESPATCH_NOTES(SHIP_METHOD)) &
			/HEADING=""

	OUTPUT_BLOCK WEIGHT /ROW=(#ROW+1) /COL=83 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK WEIGHT_UOM /ROW=(#ROW+1) /COL=94 &
			/SOURCE=(DESPATCH_NOTES(WEIGHT_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(WEIGHT)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME /ROW=(#ROW+1) /COL=100 &
			/SOURCE=(DESPATCH_NOTES(VOLUME)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK VOLUME_UOM /ROW=(#ROW+1) /COL=112 &
			/SOURCE=(DESPATCH_NOTES(VOLUME_UOM)) &
			/HEADING="" &
			/USE_IF=(DESPATCH_NOTES(VOLUME)<>0 AND #PHYSICAL_UNITS_IN_USE <> #NO)

	OUTPUT_BLOCK PROCESSED_IND /ROW=(#ROW+2) /COL=35 &
			/PROMPT=(#PROMPT(025)) &
			/SOURCE=(DESPATCH_NOTES(SYS_EC_PROCESSED_INDICATOR)) &
			/HEADING="" &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK DELIVERY_INST /ROW=(#ROW+2) /COL=51 &
			/SOURCE=(DESPATCH_NOTES(DELIVERY_INSTRUCTIONS)) &
			/HEADING=""

	BEGIN_BLOCK CHARACTERISTICS
		IF (SALES_ORDER_LINES(ORDER_LINE_TYPE)=PARAMETER("LINE_TYPE_STOCK"))
			PERFORM CHARACTERISTICS
		END_IF
	END_BLOCK

	BEGIN_BLOCK CHECK_PRINT_LINE_COMMENTS
		IF ((DESPATCH_NOTES(ORDER_NUMBER) <> "") &
		AND (DESPATCH_NOTES(ORDER_LINE_NUMBER) > 0))
			FIND IN SOP_ORDER_LINE_COMMENTS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
				/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
				/WITH=ORDER_NUMBER = DESPATCH_NOTES(ORDER_NUMBER) &
				/WITH=ORDER_LINE_NUMBER = DESPATCH_NOTES(ORDER_LINE_NUMBER) &
				/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
				/WITH=SOP_COMMENT NOT MISSING

			IF (%STATUS = %SUCCESS)
				PERFORM PRINT_LINE_COMMENTS
			END_IF
		END_IF
	END_BLOCK

END_FORM


REPORT_FORM HEADER_COMMENTS_PRINT_CONTROL &
	/OPTIONS=OVERLAID &
	/SECONDARY &
	/STREAM_NAME=PRINT_DN_ORDERS &
	/TABLE=DESPATCH_NOTES &
	/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
	/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
	/WITH=DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE) &
	/WITH=ORDER_NUMBER <> "" &
	/SORTED_BY=(ORDER_NUMBER) &
	/GROUPED_BY=(ORDER_NUMBER)

	BEGIN_BLOCK CHECK_FOR_COMMENTS
		FIND IN SOP_ORDER_HEADER_COMMENTS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE = PRINT_DN_ORDERS:DESPATCH_NOTES(COMPANY_CODE) &
			/WITH=DIVISION = PRINT_DN_ORDERS:DESPATCH_NOTES(DIVISION) &
			/WITH=ORDER_NUMBER = PRINT_DN_ORDERS:DESPATCH_NOTES(ORDER_NUMBER) &
			/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
			/WITH=SOP_COMMENT NOT MISSING

		IF (%STATUS = %SUCCESS)
			PERFORM PRINT_HEADER_COMMENTS
		END_IF
	END_BLOCK

END_FORM


REPORT_FORM PRINT_HEADER_COMMENTS &
	/READ_ONLY &
	/OPTIONS=OVERLAID &
	/TABLE=SOP_ORDER_HEADER_COMMENTS &
	/WITH=COMPANY_CODE = PRINT_DN_ORDERS:DESPATCH_NOTES(COMPANY_CODE) &
	/WITH=DIVISION = PRINT_DN_ORDERS:DESPATCH_NOTES(DIVISION) &
	/WITH=ORDER_NUMBER = PRINT_DN_ORDERS:DESPATCH_NOTES(ORDER_NUMBER) &
	/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
	/WITH=SOP_COMMENT NOT MISSING &
	/SORTED_BY=(SOP_ORDER_COMMENT_SEQUENCE) &
	/BREAK=%LINES_AFTER=1, &
		(SOP_ORDER_HEADER_COMMENTS(SOP_ORDER_COMMENT_SEQUENCE))

	OUTPUT_BLOCK COMMENT /ROW=1 /COL=7 /LEN=40 /HEIGHT=0 &
		/SOURCE=(SOP_ORDER_HEADER_COMMENTS(SOP_COMMENT)) &
		/HEADING = ""

END_FORM


REPORT_FORM PRINT_LINE_COMMENTS &
	/READ_ONLY &
	/OPTIONS=MERGED &
	/TABLE=SOP_ORDER_LINE_COMMENTS &
	/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
	/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
	/WITH=ORDER_NUMBER = DESPATCH_NOTES(ORDER_NUMBER) &
	/WITH=ORDER_LINE_NUMBER = DESPATCH_NOTES(ORDER_LINE_NUMBER) &
	/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
	/WITH=SOP_COMMENT NOT MISSING &
	/SORTED_BY=(SOP_ORDER_LINE_COMMENT_SEQ) &
	/BREAK=%LINES_AFTER=1, &
		(SOP_ORDER_LINE_COMMENTS(SOP_ORDER_LINE_COMMENT_SEQ))

	OUTPUT_BLOCK COMMENT /ROW=1 /COL=62 /LEN=40 /HEIGHT=0 &
		/SOURCE=(SOP_ORDER_LINE_COMMENTS(SOP_COMMENT)) &
		/HEADING = ""

END_FORM


REPORT_FORM CHARACTERISTICS &
	/LOCK=NONE &
	/OPTIONS=MERGED &
	/TABLE=SOP_CHARACTERISTIC_LIMITS,CHARACTERISTIC_CODES &
	/WITH=A.COMPANY_CODE=SALES_ORDER_LINES(COMPANY_CODE) &
	/WITH=A.DIVISION=SALES_ORDER_LINES(DIVISION) &
	/WITH=A.ORDER_NUMBER=SALES_ORDER_LINES(ORDER_NUMBER) &
	/WITH=A.ORDER_LINE_NUMBER=SALES_ORDER_LINES(ORDER_LINE_NUMBER) &
	/WITH=A.COMPANY_CODE=B.COMPANY_CODE &
	/WITH=A.CHARACTERISTIC_CODE=B.CHARACTERISTIC_CODE &
	/SORTED_BY=(CHARACTERISTIC_CODE)


	BEGIN_BLOCK CHARACTERISTIC_CODE
		OUTPUT_BLOCK  /ROW=1 /COL=62 &
			/SOURCE=(SOP_CHARACTERISTIC_LIMITS(CHARACTERISTIC_CODE)) &
			/LHEADING=FIELD_HEADING(CHARACTERISTIC_CODE)

		FIND IN IC_PRODUCT_CHARACTERISTICS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=SALES_ORDER_LINES(COMPANY_CODE) &
			/WITH=CHARACTERISTIC_CODE=SOP_CHARACTERISTIC_LIMITS(CHARACTERISTIC_CODE) &
			/WITH=PART_CODE=SALES_ORDER_LINES(PART_CODE)
	END_BLOCK

	OUTPUT_BLOCK CODE_DESCRIPTION /ROW=1 /COL=70 &
			/SOURCE=(CHARACTERISTIC_CODES(DESCRIPTION)) &
			/LHEADING=FIELD_HEADING(DESCRIPTION)

	BEGIN_BLOCK LOW_LIMIT_NUMERIC
		IF (CHARACTERISTIC_CODES(IC_DATATYPE_INDICATOR) = PARAMETER("IC_CHARACTERISTIC_NUMERIC"))

		OUTPUT_BLOCK  /ROW=1 /COL=101 &
			/SOURCE=(SOP_CHARACTERISTIC_LIMITS(IC_LOW_LIMIT_NUMERIC)) &
			/RHEADING=FIELD_HEADING(IC_LOW_LIMIT_NUMERIC)

		END_IF
	END_BLOCK

	BEGIN_BLOCK LOW_LIMIT_TEXT
		IF (CHARACTERISTIC_CODES(IC_DATATYPE_INDICATOR) = PARAMETER("IC_CHARACTERISTIC_TEXT"))

		OUTPUT_BLOCK  /ROW=1 /COL=101 &
			/SOURCE=(SOP_CHARACTERISTIC_LIMITS(IC_LOW_LIMIT_TEXT)) &
			/RHEADING=FIELD_HEADING(IC_LOW_LIMIT_TEXT)

		END_IF
	END_BLOCK

	BEGIN_BLOCK HIGH_LIMIT_NUMERIC
		IF (CHARACTERISTIC_CODES(IC_DATATYPE_INDICATOR) = PARAMETER("IC_CHARACTERISTIC_NUMERIC"))

		OUTPUT_BLOCK  /ROW=1 /COL=112 &
			/SOURCE=(SOP_CHARACTERISTIC_LIMITS(IC_HIGH_LIMIT_NUMERIC)) &
			/RHEADING=FIELD_HEADING(IC_HIGH_LIMIT_NUMERIC)

		END_IF
	END_BLOCK

	BEGIN_BLOCK HIGH_LIMIT_TEXT
		IF (CHARACTERISTIC_CODES(IC_DATATYPE_INDICATOR) = PARAMETER("IC_CHARACTERISTIC_TEXT"))

		OUTPUT_BLOCK  /ROW=1 /COL=112 &
			/SOURCE=(SOP_CHARACTERISTIC_LIMITS(IC_HIGH_LIMIT_TEXT)) &
			/RHEADING=FIELD_HEADING(IC_HIGH_LIMIT_TEXT)

		END_IF
	END_BLOCK

	OUTPUT_BLOCK UNIT_CHAR /ROW=1 /COL=123 &
			/SOURCE=(IC_PRODUCT_CHARACTERISTICS(UNIT_CHAR)) &
			/HEADING=FIELD_HEADING(UNIT_CHAR)

END_FORM


PROCEDURE_FORM HEADINGS_FORM

	BEGIN_BLOCK HEAD_PRINT
		FIND IN DESPATCH_HEADERS	&
			/LOCK=NONE	&
			/WITH=COMPANY_CODE = #COMPANY_CODE	&
			/WITH=DIVISION = #DIVISION	&
			/WITH=DESPATCH_NUMBER = DESPATCH_NOTES(DESPATCH_NUMBER)

		#PAGE_NUMBER = #PAGE_NUMBER + 1

		IF (#PREPRINTED)
			PERFORM HEADINGS
		ELSE
			PERFORM HEADINGS_PLAIN
		END_IF
	END_BLOCK

END_FORM


PROCEDURE_FORM HEADINGS


	OUTPUT_BLOCK BLOCK_1 /ROW=2 /COL=126 &
			/SOURCE=(#PAGE_NUMBER) &
			/OUTPUT_MASK='@@@'

	OUTPUT_BLOCK COUNTRY /ROW=6 /COL=20 &
			/SOURCE=(#COUNTRY_CODE) &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK TAX_REF /ROW=6 /COL=50 &
			/SOURCE=(#TAX_REFERENCE) &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK TAX_REF_BRANCH /ROW=6 /COL=90 &
			/SOURCE=(#TAX_REF_BRANCH) &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK CUSTOMER_NAME /ROW=9 /COL=14 /LEN=43 &
			/SOURCE=(#DELIVERY_NAME) &
			/USING=CUSTOMER_ADDRESSES(CUSTOMER_NAME)

	OUTPUT_BLOCK DESPATCH_NOTE /ROW=9 /COL=116 &
			/SOURCE=(DESPATCH_NOTES(DESPATCH_NOTE))

	OUTPUT_BLOCK DESPATCH_VERSION	/ROW=10 /COL=118	&
			/SOURCE = (DESPATCH_HEADERS(SYS_VERSION_NUMBER))

	OUTPUT_BLOCK TRANSPORT_ORDER	/ROW=12 /COL=116	&
			/SOURCE = (DESPATCH_NOTES(SOP_SHIPPING_RUN_NUMBER))	&
			/USE_IF = (DESPATCH_NOTES(TM_LOAD_PLANNING) = #YES)

	OUTPUT_BLOCK LOAD	/ROW=13	/COL=116	&
			/SOURCE = (DESPATCH_NOTES(SOP_LOAD_ID))	&
			/USE_IF = (DESPATCH_NOTES(TM_LOAD_PLANNING) = #YES)

	OUTPUT_BLOCK DEL_ADD1 /ROW=10 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_1)) &
			/SOURCE=(#DELIVERY_ADDRESS_1)

	OUTPUT_BLOCK DEL_ADD2 /ROW=11 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_2)) &
			/SOURCE=(#DELIVERY_ADDRESS_2)

!	OUTPUT_BLOCK MSDS_REQUIRED /ROW=11 /COL=116 /LEN=3 &
!			/PROMPT=(#PROMPT(027)) &
!			/SOURCE=("(*)") &
!			/USE_IF=(#DESPATCH_MSDS_REQD)

	OUTPUT_BLOCK DEL_ADD3 /ROW=12 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_3)) &
			/SOURCE=(#DELIVERY_ADDRESS_3)

	OUTPUT_BLOCK DEL_ADD4 /ROW=13 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_4)) &
			/SOURCE=(#DELIVERY_ADDRESS_4)

	OUTPUT_BLOCK DEL_ADD5 /ROW=14 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_5)) &
			/SOURCE=(#DELIVERY_ADDRESS_5)

	OUTPUT_BLOCK DEL_PHONE /ROW=15 /COL=14 &
			/SOURCE=(#DELIVERY_PHONE) &
			/OUTPUT_MASK=#PHONE_MASK

	OUTPUT_BLOCK CUSTOMER_NUMBER /ROW=13 /COL=116 &
			/SOURCE=(DESPATCH_NOTES(CUSTOMER_NUMBER))

	OUTPUT_BLOCK BLANK /ROW=19 /COL=10 &
			/SOURCE=(" ")

END_FORM


PROCEDURE_FORM HEADINGS_PLAIN


	OUTPUT_BLOCK TITLE /ROW=1 /COL=CENTER &
			/SOURCE=(#PROMPT(001))

	OUTPUT_BLOCK PAGE_2 /ROW=2 /COL=126 &
			/PROMPT=(#PROMPT(002)) &
			/SOURCE=(#PAGE_NUMBER) &
			/OUTPUT_MASK='@@@'

	OUTPUT_BLOCK COUNTRY /ROW=6 /COL=20 &
			/PROMPT=(#PROMPT(021)) &
			/SOURCE=(#COUNTRY_CODE) &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK TAX_REF /ROW=6 /COL=50 &
			/PROMPT=(#PROMPT(022)) &
			/SOURCE=(#TAX_REFERENCE) &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK TAX_REF_BRANCH /ROW=6 /COL=90 &
			/PROMPT=(#PROMPT(023)) &
			/SOURCE=(#TAX_REF_BRANCH) &
			/USE_IF=(#EC_STATS_REQD = #YES)

	OUTPUT_BLOCK DELIVER_TO /ROW=8 /COL=10 &
			/SOURCE=(#PROMPT(003))

	OUTPUT_BLOCK CUSTOMER_NAME /ROW=9 /COL=14 /LEN=43 &
			/SOURCE=(#DELIVERY_NAME) &
			/USING=CUSTOMER_ADDRESSES(CUSTOMER_NAME)

	OUTPUT_BLOCK DESPATCH_NOTE /ROW=9 /COL=116 &
			/PROMPT=(#PROMPT(005)) &
			/SOURCE=(DESPATCH_NOTES(DESPATCH_NOTE))

	OUTPUT_BLOCK DESPATCH_VERSION	/ROW=10 /COL=118	&
			/PROMPT = (#PROMPT(031))	&
			/SOURCE = (DESPATCH_HEADERS(SYS_VERSION_NUMBER))

	OUTPUT_BLOCK TRANSPORT_ORDER	/ROW=12 /COL=116	&
			/PROMPT = (#PROMPT(028))	&
			/SOURCE = (DESPATCH_NOTES(SOP_SHIPPING_RUN_NUMBER))	&
			/USE_IF = (DESPATCH_NOTES(TM_LOAD_PLANNING) = #YES)

	OUTPUT_BLOCK LOAD	/ROW=13	/COL=116	&
			/PROMPT = (#PROMPT(029))	&
			/SOURCE = (DESPATCH_NOTES(SOP_LOAD_ID))	&
			/USE_IF = (DESPATCH_NOTES(TM_LOAD_PLANNING) = #YES)

	OUTPUT_BLOCK DEL_ADD1 /ROW=10 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_1)) &
			/SOURCE=(#DELIVERY_ADDRESS_1)

	OUTPUT_BLOCK DEL_ADD2 /ROW=11 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_2)) &
			/SOURCE=(#DELIVERY_ADDRESS_2)

	OUTPUT_BLOCK MSDS_REQUIRED /ROW=11 /COL=116 /LEN=3 &
			/PROMPT=(#PROMPT(027)) &
			/SOURCE=("(*)") &
			/USE_IF=(#DESPATCH_MSDS_REQD)

	OUTPUT_BLOCK DEL_ADD3 /ROW=12 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_3)) &
			/SOURCE=(#DELIVERY_ADDRESS_3)

	OUTPUT_BLOCK DEL_ADD4 /ROW=13 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_4)) &
			/SOURCE=(#DELIVERY_ADDRESS_4)

	OUTPUT_BLOCK DEL_ADD5 /ROW=14 /COL=14 /LEN=(LEN(#DELIVERY_ADDRESS_5)) &
			/SOURCE=(#DELIVERY_ADDRESS_5)

	OUTPUT_BLOCK DEL_PHONE /ROW=15 /COL=14 &
			/PROMPT=(#PROMPT(008)) &
			/SOURCE=(#DELIVERY_PHONE) &
			/OUTPUT_MASK=#PHONE_MASK

	OUTPUT_BLOCK DELIVER_FROM /ROW=8 /COL=54 &
			/SOURCE=(#PROMPT(004))

	OUTPUT_BLOCK COMPANY_NAME /ROW=9 /COL=60 /LEN=(LEN(#COMPANY_NAME)) &
			/SOURCE=(#COMPANY_NAME)

	OUTPUT_BLOCK OUR_ADDRESS_1 /ROW=10 /COL=60 /LEN=(LEN(#OUR_ADDRESS_1)) &
			/SOURCE=(#OUR_ADDRESS_1)

	OUTPUT_BLOCK OUR_ADDRESS_2 /ROW=11 /COL=60 /LEN=(LEN(#OUR_ADDRESS_2)) &
			/SOURCE=(#OUR_ADDRESS_2)

	OUTPUT_BLOCK OUR_ADDRESS_3 /ROW=12 /COL=60 /LEN=(LEN(#OUR_ADDRESS_3)) &
			/SOURCE=(#OUR_ADDRESS_3)

	OUTPUT_BLOCK OUR_ADDRESS_4 /ROW=13 /COL=60 /LEN=(LEN(#OUR_ADDRESS_4)) &
			/SOURCE=(#OUR_ADDRESS_4)

	OUTPUT_BLOCK OUR_ADDRESS_5 /ROW=14 /COL=60 /LEN=(LEN(#OUR_ADDRESS_5)) &
			/SOURCE=(#OUR_ADDRESS_5)

	OUTPUT_BLOCK CUSTOMER_NUMBER /ROW=14 /COL=116 &
			/PROMPT=(#PROMPT(007)) &
			/SOURCE=(DESPATCH_NOTES(CUSTOMER_NUMBER)) &
			/USE_IF = (DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE) = "")

	OUTPUT_BLOCK DEST_WAREHOUSE /ROW=14 /COL=116 &
			/PROMPT=(#PROMPT(007)) &
			/SOURCE=(DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)) &
			/USE_IF = (DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE) <> "")

	OUTPUT_BLOCK BLANK /ROW=19 /COL=10 &
			/SOURCE=(" ")

END_FORM


PROCEDURE_FORM NEXT_PAGE &
	/LINES_AFTER=TOP_OF_PAGE


	OUTPUT_BLOCK BLANK /ROW=1 /COL=1 &
			/SOURCE=(" ")

END_FORM


PROCEDURE_FORM SKIP_LINE


	OUTPUT_BLOCK BLOCK_1 /ROW=1 /COL=1 &
			/SOURCE=("    ")

END_FORM


PROCEDURE_FORM DC_SETUP


	BEGIN_BLOCK NEW_WAREHOUSE
		#WAREHOUSE = DESPATCH_NOTES(WAREHOUSE)

		FIND IN WAREHOUSE_CONTROLS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=WAREHOUSE=#WAREHOUSE

		#DATA_CAPTURE_IN_USE = WAREHOUSE_CONTROLS(DATA_CAPTURE_IN_USE)

		IF  (#DATA_CAPTURE_IN_USE = "")  #DATA_CAPTURE_IN_USE = #NO

		IF (#DATA_CAPTURE_IN_USE = #YES)
			FIND IN ISSUE_SEQUENCE_NUMBERS &
				/LOCK=WRITE

			#SEQUENCE_NUMBER = ISSUE_SEQUENCE_NUMBERS(NEXT_SEQUENCE_NUMBER) + 1
			ISSUE_SEQUENCE_NUMBERS(NEXT_SEQUENCE_NUMBER) = #SEQUENCE_NUMBER
		END_IF
	END_BLOCK

END_FORM

PROCEDURE_FORM NEW_CUSTOMER

	BEGIN_BLOCK CUSTOMER
		#CUSTOMER_NUMBER = DESPATCH_NOTES(CUSTOMER_NUMBER)
		#CUSTOMER_MSDS_REQD = 0
	END_BLOCK

END_FORM


PROCEDURE_FORM PRINT_MSDS

	BEGIN_BLOCK PRINT
		! load the vt, set the print flag on SOP_DESPATCH_NOTE_MSDS, and set #CUSTOMER_MSDS_REQD
  		PERFORM NEW_DESPATCH_NOTE

		IF (NOT #CUSTOMER_MSDS_REQD) EXIT (%SUCCESS)

		PERFORM 'GEMSOP:SOP_L_MSDS' PRINT_VT( &
				(#SOP_ORDER_CYCLE_B), &
				(#R_NAME_MSDS_PORTRAIT), &
				(#R_NAME_MSDS_LANDSCAPE), &
				(#COMPANY_CODE), &
				(#DIVISION), &
				(#COUNTRY_CODE), &
				(#EC_STATS_REQD), &
				(#COMPANY_NAME), &
				(#OUR_ADDRESS_1), &
				(#OUR_ADDRESS_2), &
				(#OUR_ADDRESS_3), &
				(#OUR_ADDRESS_4), &
				(#OUR_ADDRESS_5), &
				"","","", &
				#PORTRAIT_CREATED, &
				#LANDSCAPE_CREATED)

		IF (#PORTRAIT_CREATED) #MSDS_PORTRAIT_CREATED = 1
		IF (#LANDSCAPE_CREATED) #MSDS_LANDSCAPE_CREATED = 1
	END_BLOCK

END_FORM

REPORT_FORM NEW_DELIVERY_ADDRESS

	BEGIN_BLOCK DEST_WAREHOUSE
		IF (DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE) <> "")
			EXIT
		END_IF
	END_BLOCK

	BEGIN_BLOCK CUST_NAME

		! The following check may be redundant as the initial
		! stream selection joins DESPATCH_NOTES and CUSTOMER_ADDRESSES
		! on the Delivery Address Code field - the Delivery Address
		! Code field on the Customer Addresses table cannot be blank.
		!
		IF (DESPATCH_NOTES(DELIVERY_ADDRESS_CODE) <> "")
			FIND IN CUSTOMER_ADDRESSES &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=DIVISION=#DIVISION &
				/WITH=CUSTOMER_NUMBER=DESPATCH_NOTES(CUSTOMER_NUMBER) &
				/WITH=ADDRESS_CODE=DESPATCH_NOTES(DELIVERY_ADDRESS_CODE)

			#PRINT_LANGUAGE = CUSTOMER_ADDRESSES(SYS_LANGUAGE_CODE)
			#COUNTRY_CODE 	= CUSTOMER_ADDRESSES(SYS_COUNTRY)
			#DELIVERY_NAME	= CUSTOMER_ADDRESSES(CUSTOMER_NAME)
			#DELIVERY_PHONE	= CUSTOMER_ADDRESSES(PHONE)
		ELSE
			FIND IN CUSTOMERS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE=#COMPANY_CODE &
				/WITH=DIVISION=#DIVISION &
				/WITH=CUSTOMER_NUMBER=#CUSTOMER_NUMBER

			#PRINT_LANGUAGE = CUSTOMERS(SYS_LANGUAGE_CODE)
			#COUNTRY_CODE 	= CUSTOMERS(SYS_COUNTRY)
			#DELIVERY_NAME	= CUSTOMERS(CUSTOMER_NAME)
			#DELIVERY_PHONE	= CUSTOMERS(PHONE)
		END_IF

		FIND IN SYS_COUNTRIES &
			/LOCK=NONE &
			/WITH=SYS_COUNTRY=#COUNTRY_CODE

		IF (%STATUS=%FAILURE)
			IF (#CALL_MODE = #CALL_MODE_WS) 
				! "Country record not found for !AS"
				PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
					("FIN", "P_12202", "", #ERR_WARN, 0, #COUNTRY_CODE, "", "", "", "")
			ELSE			
				MESSAGE/IDENTIFIER/BELL/WAIT P_12202,#COUNTRY_CODE
			END_IF

			#DELIVERY_ADDRESS_1 = ""
			#DELIVERY_ADDRESS_2 = ""
			#DELIVERY_ADDRESS_3 = ""
			#DELIVERY_ADDRESS_4 = ""
			#DELIVERY_ADDRESS_5 = ""
		ELSE
			PERFORM "GEMLB:LB_ADDRESSES" &
					("R",#COUNTRY_CODE, &
					"CUSTOMER_ADDRESSES", &
					"","","","","","","", &
					#R1,#R2,#R3,#R4,#R5)

			#DELIVERY_ADDRESS_1 = #R1
			#DELIVERY_ADDRESS_2 = #R2
			#DELIVERY_ADDRESS_3 = #R3
			#DELIVERY_ADDRESS_4 = #R4
			#DELIVERY_ADDRESS_5 = #R5

			#PHONE_MASK = SYS_COUNTRIES(SYS_PHONE_MASK)
		END_IF
	END_BLOCK

	BEGIN_BLOCK DATE_MASK
		IF (SYS_COUNTRIES(SYS_DATE_MASK) <> "" )
			#DATE_MASK = SYS_COUNTRIES(SYS_DATE_MASK)
		ELSE
			#DATE_MASK = "!DD-!3Lm-!LY"
		END_IF
	END_BLOCK

	BEGIN_BLOCK CHECK_ORDER_HEADER_COMMENTS
		#HEADER_COMMENTS_PRINTED = #NO
		#HEADER_COMMENTS_TO_PRINT = #NO

		START_STREAM DN_ORDERS &
			/SECONDARY &
			/TABLE=DESPATCH_NOTES &
			/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
			/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
			/WITH=DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE) &
			/WITH=ORDER_NUMBER <> "" &
			/SORTED_BY=(ORDER_NUMBER) &
			/GROUPED_BY=(ORDER_NUMBER)

		WHILE (1)
			FETCH DN_ORDERS /FAILURE=(CONTINUE OUT)

			FIND IN SOP_ORDER_HEADER_COMMENTS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE = DN_ORDERS:DESPATCH_NOTES(COMPANY_CODE) &
				/WITH=DIVISION = DN_ORDERS:DESPATCH_NOTES(DIVISION) &
				/WITH=ORDER_NUMBER = DN_ORDERS:DESPATCH_NOTES(ORDER_NUMBER) &
				/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
				/WITH=SOP_COMMENT NOT MISSING

			IF (%STATUS = %SUCCESS)
				#HEADER_COMMENTS_TO_PRINT = #YES
			END_IF

			IF (#HEADER_COMMENTS_TO_PRINT = #YES) CONTINUE OUT
		END_WHILE
	END_BLOCK

	BEGIN_BLOCK ALL_OR_019_AND_020
		IF (#LAST_LANGUAGE_CODE = #PRINT_LANGUAGE) EXIT (%SUCCESS)

		#LAST_LANGUAGE_CODE = #PRINT_LANGUAGE

		IF (NOT #PREPRINTED) GOTO GET_PROMPTS

		#PROMPT(019) = FIELD_PROMPT(BIN_LOCATION)
		#PROMPT(020) = FIELD_SHORT_PROMPT(MH_NUMBER)
		#PROMPT(021) = FIELD_PROMPT(SYS_COUNTRY)
		#PROMPT(022) = FIELD_PROMPT(TAX_REFERENCE)
		#PROMPT(023) = FIELD_PROMPT(SYS_TAX_REFERENCE_BRANCH)
		#PROMPT(024) = FIELD_PROMPT(SYS_TARIFF_CODE)
		#PROMPT(025) = FIELD_PROMPT(SYS_EC_PROCESSED_INDICATOR)

		IF (#PRINT_LANGUAGE <> #NATIVE_LANGUAGE_CODE)
			! If printing on preprinted stationary
			! but the customer language is foreign
			! Delivery Date will still have to be in the
			! customer's language

			FIND IN SYS_DOCUMENT_PROMPTS &
				/LOCK=NONE &
				/WITH=SYS_DOCUMENT_CODE=#DOCUMENT_NAME &
				/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
				/WITH=SEQUENCE=19

			IF (%STATUS = %SUCCESS)
				#PROMPT(019)=SYS_DOCUMENT_PROMPTS(SYS_LANGUAGE_PROMPT)
			END_IF

			FIND IN SYS_DOCUMENT_PROMPTS &
				/LOCK=NONE &
				/WITH=SYS_DOCUMENT_CODE=#DOCUMENT_NAME &
				/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
				/WITH=SEQUENCE=20

			IF (%STATUS = %SUCCESS)
				#PROMPT(020)=SYS_DOCUMENT_PROMPTS(SYS_LANGUAGE_PROMPT)
			END_IF
		END_IF

		#PROMPT(031) = FIELD_PROMPT(SYS_VERSION_NUMBER)
		#PROMPT(032) = FIELD_SHORT_PROMPT(TM_CONTAINER_SEAL)

		EXIT (%SUCCESS)
	END_BLOCK

	BEGIN_BLOCK GET_PROMPTS

		START_STREAM LA &
			/LOCK=NONE &
			/TABLE=SYS_DOCUMENT_PROMPTS &
			/WITH=SYS_DOCUMENT_CODE=#DOCUMENT_NAME &
			/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE

		FETCH LA/FAILURE=(GOTO DEFAULT_PROMPTS)

		WHILE (1)
			#PROMPT(LA:SYS_DOCUMENT_PROMPTS(SEQUENCE))= &
				LA:SYS_DOCUMENT_PROMPTS(SYS_LANGUAGE_PROMPT)
			FETCH LA /FAILURE=(CONTINUE OUT)
		END_WHILE

		EXIT (%SUCCESS)
	END_BLOCK

	BEGIN_BLOCK DEFAULT_PROMPTS

		IF (#CALL_MODE = #CALL_MODE_WS) 
			! "No prompts for language !AS. Defaults used."
			PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
				("FIN", "P_12073", "", #ERR_WARN, 0, #PRINT_LANGUAGE, "", "", "", "")
		ELSE			
			MESSAGE/IDENTIFIER/BELL P_12073,#PRINT_LANGUAGE
		END_IF

		#PROMPT(002) = (MESSAGE("P_19059"))
			! Page
		#PROMPT(003) = (MESSAGE("P_6CORP_OFFICE_NAME_1"))
		#PROMPT(004) = (MESSAGE("P_00290"))
			! From
		#PROMPT(005) = FIELD_PROMPT(DESPATCH_NOTE)
		#PROMPT(006) = (MESSAGE("P_12104"))
			!Delivery Date
		#PROMPT(007) = FIELD_PROMPT(CUSTOMER_NUMBER)
		#PROMPT(008) = FIELD_PROMPT(PHONE)

		#PROMPT(009) = FIELD_HEADING(DESPATCH_LINE)
		#PROMPT(010) = FIELD_HEADING(PART_CODE)
		#PROMPT(011) = FIELD_HEADING(WAREHOUSE)
		#PROMPT(012) = FIELD_HEADING(IC_LOT_NUMBER)
		#PROMPT(013) = FIELD_HEADING(PART_DESC_1)
		#PROMPT(014) = FIELD_HEADING(ORDER_NUMBER)
		#PROMPT(015) = FIELD_HEADING(ORDER_LINE_NUMBER)
		#PROMPT(016) = FIELD_PROMPT(SYS_SHIPPING_DATE)
		#PROMPT(017) = FIELD_HEADING(UNIT_PICK)
		#PROMPT(018) = FIELD_HEADING(DESPATCH_QTY_ACTUAL)

		#PROMPT(019) = FIELD_PROMPT(BIN_LOCATION)
		#PROMPT(020) = FIELD_SHORT_PROMPT(MH_NUMBER)

		#PROMPT(021) = FIELD_PROMPT(SYS_COUNTRY)
		#PROMPT(022) = FIELD_PROMPT(TAX_REFERENCE)
		#PROMPT(023) = FIELD_PROMPT(SYS_TAX_REFERENCE_BRANCH)
		#PROMPT(024) = FIELD_PROMPT(SYS_TARIFF_CODE)
		#PROMPT(025) = FIELD_PROMPT(SYS_EC_PROCESSED_INDICATOR)
		#PROMPT(026) = FIELD_HEADING(IC_LOT_SEQUENCE)
		#PROMPT(027) = MESSAGE("P_82962")
			! MSDS Required
		#PROMPT(028) = FIELD_PROMPT(SOP_SHIPPING_RUN_NUMBER)
		#PROMPT(029) = FIELD_PROMPT(SOP_LOAD_ID)
		#PROMPT(031) = FIELD_PROMPT(SYS_VERSION_NUMBER)
	END_BLOCK

END_FORM

PROCEDURE_FORM NEW_DESPATCH_NOTE

	BEGIN_BLOCK MSDS

		#DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE)
		#SHIP_DATE = %TODAY

		PERFORM 'GEMSOP:SOP_L_MSDS' LOAD_PRINT_VT( &
				(#SOP_ORDER_CYCLE_B), &
				(#COMPANY_CODE), &
				(#DIVISION), &
				(DESPATCH_NOTES(DESPATCH_NUMBER)), &
				(#DESPATCH_NOTE), &
				#SHIP_DATE, &
				#DESPATCH_MSDS_REQD)

		IF (#DESPATCH_MSDS_REQD) #CUSTOMER_MSDS_REQD = 1
	END_BLOCK

END_FORM

!PROCEDURE_FORM SEND_MESSAGE


!	BEGIN_BLOCK LOAD_RECORD
!		CLEAR_BUFFER ISSUE_INSTRUCTIONS

!		ISSUE_INSTRUCTIONS(INSTRUCTION_IDENTIFIER)	= "SODESP"
!		ISSUE_INSTRUCTIONS(COMPANY_CODE)		= DESPATCH_NOTES(COMPANY_CODE)
!		ISSUE_INSTRUCTIONS(WAREHOUSE)			= DESPATCH_NOTES(WAREHOUSE)
!		ISSUE_INSTRUCTIONS(BIN_LOCATION)		= DESPATCH_NOTES(BIN_LOCATION)
!		ISSUE_INSTRUCTIONS(PART_CODE)			= DESPATCH_NOTES(PART_CODE)
!		ISSUE_INSTRUCTIONS(MOVEMENT_QTY)		= DESPATCH_NOTES(DESPATCH_QTY)
!		ISSUE_INSTRUCTIONS(UNIT_OF_MEASURE)		= DESPATCH_NOTES(UNIT_PICK)
!		ISSUE_INSTRUCTIONS(MH_NUMBER)			= DESPATCH_NOTES(MH_NUMBER)
!		IF (DESPATCH_NOTES(MH_NUMBER) = "")
!			ISSUE_INSTRUCTIONS(PALLET_REQUIRED)	= #NO
!		ELSE
!			ISSUE_INSTRUCTIONS(PALLET_REQUIRED)	= #YES
!		END_IF

!		#REFERENCE = #COMPANY_CODE & "/" & &
!			DESPATCH_NOTES(DIVISION) & "/" & &
!			DESPATCH_NOTES(DESPATCH_NUMBER) & "/" & &
!			DESPATCH_NOTES(DESPATCH_SEQUENCE)
!
!		ISSUE_INSTRUCTIONS(INTERFACE_REFERENCE) = #REFERENCE
!		ISSUE_INSTRUCTIONS(PICK_LIST)		= DESPATCH_NOTES(DESPATCH_NOTE)
!		ISSUE_INSTRUCTIONS(ISSUE_SEQUENCE)      = #SEQUENCE_NUMBER

!		ADD TO ISSUE_INSTRUCTIONS
!		IF (%STATUS = %FAILURE)
!			MESSAGE/IDENTIFIER/BELL/WAIT P_59043
!			EXIT(%FAILURE)
!		END_IF
!	END_BLOCK

!END_FORM


!PROCEDURE_FORM INTER_PROCESS_MESSAGE
!

!	BEGIN_BLOCK SEND_MESSAGE
!		IF (#SEQUENCE_NUMBER <> "")
!			SEND ISSINS/WAIT #SEQUENCE_NUMBER
!		END_IF
!	END_BLOCK

!END_FORM


PROCEDURE_FORM GET_OUR_ADDRESS

	BEGIN_BLOCK OUR_ADDRESS

		FIND IN COMPANY_CONTROLS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE

		IF ((%STATUS=%FAILURE) OR (%STATUS=%EMPTY))
			IF (#CALL_MODE = #CALL_MODE_WS) 
				! "Delivery Address not found"
				PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
					("FIN", "P_00817", "", #ERR_FATAL, 0, "", "", "", "", "")
			ELSE			
				MESSAGE/IDENTIFIER/BELL/WAIT P_00817
			END_IF 
			EXIT (%FAILURE)
		END_IF

		#COMPANY_NAME	= COMPANY_CONTROLS(COMPANY_NAME)
		#COUNTRY_CODE	= COMPANY_CONTROLS(SYS_COUNTRY)
		#TAX_REFERENCE	= COMPANY_CONTROLS(TAX_REFERENCE)
		#TAX_REF_BRANCH	= COMPANY_CONTROLS(SYS_TAX_REFERENCE_BRANCH)
		#EC_STATS_REQD	= COMPANY_CONTROLS(SYS_EC_STATS_REQUIRED)

		FIND IN SYS_COUNTRIES &
			/LOCK=NONE &
			/WITH=SYS_COUNTRY=#COUNTRY_CODE

		IF (%STATUS = %FAILURE)
			IF (#CALL_MODE = #CALL_MODE_WS) 
				! "Country record not found for !AS"
				PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
					("FIN", "P_12202", "", #ERR_FATAL, 0, #COUNTRY_CODE, "", "", "", "")
			ELSE			
				MESSAGE/IDENTIFIER/BELL/WAIT P_12202,#COUNTRY_CODE
			END_IF
			EXIT (%FAILURE)
		END_IF

		PERFORM "GEMLB:LB_ADDRESSES" &
				("R",#COUNTRY_CODE, &
				"COMPANY_CONTROLS", &
				"","","","","","","", &
				#R1,#R2,#R3,#R4,#R5)

		#OUR_ADDRESS_1 = #R1
		#OUR_ADDRESS_2 = #R2
		#OUR_ADDRESS_3 = #R3
		#OUR_ADDRESS_4 = #R4
		#OUR_ADDRESS_5 = #R5

	END_BLOCK

END_FORM

PROCEDURE_FORM QUANTITY_UOM (#UNIT_SALES,#SALES_DESPATCH,#MASK_1,#UNIT_PACK,#PACK_DESPATCH,#MASK_2,&
                             #NOMINATED,#NOMINATED_DESPATCH,#MASK_3,#UNIT_OTHER,#OTHER_DESPATCH,#MASK_4)

        BEGIN_BLOCK PACKAGE_UNIT
                IF (DESPATCH_NOTES(NONSTOCK) = (PARAMETER("LANGUAGE_YES")))
                        #MASK_2 = ""
			#MASK_3 = ""
			#MASK_4 = ""
                END_IF

                IF (#UNIT_PACK = "")
			#MASK_2 = ""
		ELSE

                        FIND IN IC_PRODUCT_MASTER_UNITS &
                                /LOCK=NONE &
                                /WITH=COMPANY_CODE = #COMPANY_CODE &
                                /WITH=PART_CODE = DESPATCH_NOTES(PART_CODE) &
                                /WITH=UNIT_OF_MEASURE = #UNIT_PACK &
                                /WITH=IC_QUANTITY_MASK <> "" &
                                /WITH=IC_PRODUCT_UOM_TYPE = PARAMETER("IC_PACKAGED_UOM")

                        IF (%STATUS <> %SUCCESS)
                                FIND IN UNITS_OF_MEASURE &
                                        /LOCK=NONE &
                                        /WITH=UNIT_OF_MEASURE =  #UNIT_PACK

                                IF (%STATUS = %SUCCESS)
                                        #MASK_2 = UNITS_OF_MEASURE(IC_QUANTITY_MASK)
                                ELSE
					IF (#CALL_MODE = #CALL_MODE_WS) 
						! "Failed to obtain mask"
						PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
							("FIN", "P_90907", "", #ERR_WARN, &
							0, "", "", "", "", "")
					ELSE			
						MESSAGE/BELL/IDENTIFIER/WAIT P_90907
					END_IF
                                END_IF
                        ELSE
                                #MASK_2 = IC_PRODUCT_MASTER_UNITS(IC_QUANTITY_MASK)
                        END_IF

                END_IF

        END_BLOCK

        BEGIN_BLOCK NOMINATED_UNIT

                IF (#NOMINATED = "")
                        #MASK_3 = ""
                ELSE
                        FIND IN IC_PRODUCT_MASTER_UNITS &
                                /WITH=COMPANY_CODE = #COMPANY_CODE &
                                /WITH=PART_CODE = DESPATCH_NOTES(PART_CODE) &
                                /WITH=UNIT_OF_MEASURE = #NOMINATED &
                                /WITH=IC_QUANTITY_MASK <> "" &
                                /LOCK=NONE

                        IF (%STATUS <> %SUCCESS)
                                FIND IN UNITS_OF_MEASURE &
                                        /LOCK=NONE &
                                        /WITH=UNIT_OF_MEASURE =  #NOMINATED

                                IF (%STATUS = %SUCCESS)
                                        #MASK_3 = UNITS_OF_MEASURE(IC_QUANTITY_MASK)
                                ELSE
					IF (#CALL_MODE = #CALL_MODE_WS) 
						! "Failed to obtain mask"
						PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
							("FIN", "P_90907", "", #ERR_WARN, &
							0, "", "", "", "", "")
					ELSE			
       	                                 MESSAGE/BELL/IDENTIFIER/WAIT P_90907
					END_IF
                                END_IF
                       ELSE
                                #MASK_3 = IC_PRODUCT_MASTER_UNITS(IC_QUANTITY_MASK)
			END_IF
                END_IF
        END_BLOCK

        BEGIN_BLOCK OTHER_UNIT
                IF (#UNIT_OTHER = "")
                        #MASK_4 = ""
                ELSE
                        FIND IN IC_PRODUCT_MASTER_UNITS &
                                /WITH=COMPANY_CODE = #COMPANY_CODE &
                                /WITH=PART_CODE = DESPATCH_NOTES(PART_CODE) &
                                /WITH=UNIT_OF_MEASURE = #UNIT_OTHER &
                                /WITH=IC_QUANTITY_MASK <> "" &
                                /LOCK=NONE

                        IF (%STATUS <> %SUCCESS)
                                FIND IN UNITS_OF_MEASURE &
                                        /LOCK=NONE &
                                        /WITH=UNIT_OF_MEASURE =  #UNIT_OTHER

                                IF (%STATUS = %SUCCESS)
                                        #MASK_4 = UNITS_OF_MEASURE(IC_QUANTITY_MASK)
                                ELSE
					IF (#CALL_MODE = #CALL_MODE_WS) 
						! "Failed to obtain mask"
						PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
							("FIN", "P_90907", "", #ERR_WARN, &
							0, "", "", "", "", "")
					ELSE			
						MESSAGE/BELL/IDENTIFIER/WAIT P_90907
					END_IF
                                END_IF

                        ELSE
                                #MASK_4 = IC_PRODUCT_MASTER_UNITS(IC_QUANTITY_MASK)
                        END_IF
                END_IF
        END_BLOCK


        BEGIN_BLOCK SALES_UNIT

                IF (#UNIT_SALES = "")
                        #MASK_1 = ""
                ELSE
                        FIND IN IC_PRODUCT_MASTER_UNITS &
                                /WITH=COMPANY_CODE = #COMPANY_CODE &
                                /WITH=PART_CODE = DESPATCH_NOTES(PART_CODE) &
                                /WITH=UNIT_OF_MEASURE = #UNIT_SALES &
                                /WITH=IC_QUANTITY_MASK <> "" &
                                /LOCK=NONE

                        IF (%STATUS <> %SUCCESS)
                                FIND IN UNITS_OF_MEASURE &
                                        /LOCK=NONE &
                                        /WITH=UNIT_OF_MEASURE =  #UNIT_SALES

                                IF (%STATUS = %SUCCESS)
                                        #MASK_1 = UNITS_OF_MEASURE(IC_QUANTITY_MASK)
                                ELSE
					IF (#CALL_MODE = #CALL_MODE_WS) 
						! "Failed to obtain mask"
						PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
							("FIN", "P_90907", "", #ERR_WARN, &
							0, "", "", "", "", "")
					ELSE			
						MESSAGE/BELL/IDENTIFIER/WAIT P_90907
					END_IF
                                END_IF

                        ELSE
                                #MASK_1 = IC_PRODUCT_MASTER_UNITS(IC_QUANTITY_MASK)
                        END_IF
                END_IF
        END_BLOCK
END_FORM

PROCEDURE_FORM GET_IN_DESPATCH_QTY( #UOM, #IN_DESPATCH_QTY)

	BEGIN_BLOCK INIT
		#IN_DESPATCH_QTY	= 0
		IF (#UOM = "")
			EXIT
		END_IF
	END_BLOCK

	BEGIN_BLOCK GET
		FIND IN DESPATCH_NOTE_QTYS	&
			/LOCK = NONE	&
			/WITH=COMPANY_CODE = #COMPANY_CODE	&
			/WITH=DIVISION = DESPATCH_NOTES(DIVISION)	&
			/WITH=DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE)	&
			/WITH=DESPATCH_LINE = DESPATCH_NOTES(DESPATCH_LINE)	&
			/WITH=UNIT_OF_MEASURE = #UOM

		IF (%STATUS <> %SUCCESS)
			#IN_DESPATCH_QTY	= 0
			EXIT (%FAILURE)
		END_IF

		#IN_DESPATCH_QTY	= DESPATCH_NOTE_QTYS(IC_QTY_IN_DESPATCH)
	END_BLOCK
END_FORM

REPORT_FORM NEW_LOAD &
	/OPTIONS=OVERLAYED

	BEGIN_BLOCK LOAD
		FIND IN TM_SHIPMENT_LOAD &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=AP_DIVISION=DESPATCH_HEADERS(AP_DIVISION) &
			/WITH=TM_LOAD_NUMBER = DESPATCH_NOTES(TM_LOAD_NUMBER)

		FIND IN TM_TRANSPORT_ORDER &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=AP_DIVISION=DESPATCH_HEADERS(AP_DIVISION) &
			/WITH=TM_ORDER_NUMBER=DESPATCH_HEADERS(TM_ORDER_NUMBER)

		FIND IN VENDORS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=AP_DIVISION=TM_TRANSPORT_ORDER(AP_DIVISION) &
			/WITH=VENDOR_NUMBER=TM_TRANSPORT_ORDER(VENDOR_NUMBER)

	END_BLOCK

END_FORM

REPORT_FORM NEW_DEST_WAREHOUSE

	BEGIN_BLOCK WAREHOUSE

		IF (DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)="") EXIT

		FIND IN WAREHOUSE_CONTROLS &
			/LOCK=NONE &
			/WITH=COMPANY_CODE=#COMPANY_CODE &
			/WITH=WAREHOUSE=DESPATCH_NOTES(SOP_DESTINATION_WAREHOUSE)

		#CUSTOMER_NUMBER = ""
!		#DELIVERY_ADDRESS_CODE = ""
!		#CUSTOMER_MSDS_REQD = 0
		#PRINT_LANGUAGE = #NATIVE_LANGUAGE_CODE
		#COUNTRY_CODE = WAREHOUSE_CONTROLS(SYS_COUNTRY)
		#DELIVERY_NAME = WAREHOUSE_CONTROLS(WAREHOUSE_DESCRIPTION)
		#DELIVERY_PHONE	= ""

		FIND IN SYS_COUNTRIES &
			/LOCK=NONE &
			/WITH=SYS_COUNTRY=#COUNTRY_CODE

		IF (%STATUS = %FAILURE)
			IF (#CALL_MODE = #CALL_MODE_WS) 
				! "Country record not found for !AS"
				PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
					("FIN", "P_12202", "", #ERR_WARN, 0, #COUNTRY_CODE, "", "", "", "")
			ELSE			
				MESSAGE/IDENTIFIER/BELL/WAIT P_12202,#COUNTRY_CODE
			END_IF
			
			#DELIVERY_ADDRESS_1 = ""
			#DELIVERY_ADDRESS_2 = ""
			#DELIVERY_ADDRESS_3 = ""
			#DELIVERY_ADDRESS_4 = ""
			#DELIVERY_ADDRESS_5 = ""
		ELSE
			PERFORM "GEMLB:LB_ADDRESSES" &
					("R",#COUNTRY_CODE, &
					"WAREHOUSE_CONTROLS", &
					"","","","","","","", &
					#R1,#R2,#R3,#R4,#R5)

			#DELIVERY_ADDRESS_1 = #R1
			#DELIVERY_ADDRESS_2 = #R2
			#DELIVERY_ADDRESS_3 = #R3
			#DELIVERY_ADDRESS_4 = #R4
			#DELIVERY_ADDRESS_5 = #R5

			#PHONE_MASK = SYS_COUNTRIES(SYS_PHONE_MASK)
		END_IF
	END_BLOCK

	BEGIN_BLOCK DATE_MASK
		IF (SYS_COUNTRIES(SYS_DATE_MASK) <> "" )
			#DATE_MASK = SYS_COUNTRIES(SYS_DATE_MASK)
		ELSE
			#DATE_MASK = "!DD-!3Lm-!LY"
		END_IF
	END_BLOCK

	BEGIN_BLOCK CHECK_ORDER_HEADER_COMMENTS
		#HEADER_COMMENTS_PRINTED = #NO
		#HEADER_COMMENTS_TO_PRINT = #NO

		START_STREAM DN_ORDERS &
			/SECONDARY &
			/TABLE=DESPATCH_NOTES &
			/WITH=COMPANY_CODE = DESPATCH_NOTES(COMPANY_CODE) &
			/WITH=DIVISION = DESPATCH_NOTES(DIVISION) &
			/WITH=DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE) &
			/WITH=ORDER_NUMBER <> "" &
			/SORTED_BY=(ORDER_NUMBER) &
			/GROUPED_BY=(ORDER_NUMBER)

		WHILE (1)
			FETCH DN_ORDERS /FAILURE=(CONTINUE OUT)

			FIND IN SOP_ORDER_HEADER_COMMENTS &
				/LOCK=NONE &
				/WITH=COMPANY_CODE = DN_ORDERS:DESPATCH_NOTES(COMPANY_CODE) &
				/WITH=DIVISION = DN_ORDERS:DESPATCH_NOTES(DIVISION) &
				/WITH=ORDER_NUMBER = DN_ORDERS:DESPATCH_NOTES(ORDER_NUMBER) &
				/WITH=SOP_PRINT_ON_CON_NOTE = #YES &
				/WITH=SOP_COMMENT NOT MISSING

			IF (%STATUS = %SUCCESS)
				#HEADER_COMMENTS_TO_PRINT = #YES
			END_IF

			IF (#HEADER_COMMENTS_TO_PRINT = #YES) CONTINUE OUT
		END_WHILE
	END_BLOCK

	BEGIN_BLOCK ALL_OR_019_AND_020
		IF (#LAST_LANGUAGE_CODE = #PRINT_LANGUAGE) EXIT (%SUCCESS)
		#LAST_LANGUAGE_CODE = #PRINT_LANGUAGE

		PERFORM INIT_LANGUAGE
	END_BLOCK

END_FORM

PROCEDURE_FORM PRINT_ORDER_COMMENTS_REP

END_FORM

PROCEDURE_FORM PRINT_ORDER_LINE_COMMENTS

END_FORM

PROCEDURE_FORM REPORT

END_FORM


PROCEDURE_FORM INIT_LANGUAGE
	BEGIN_BLOCK INIT
		IF (NOT #PREPRINTED) GOTO GET_PROMPTS

		#PROMPT(019) = FIELD_PROMPT(BIN_LOCATION)
		#PROMPT(020) = FIELD_SHORT_PROMPT(MH_NUMBER)
		#PROMPT(021) = FIELD_PROMPT(SYS_COUNTRY)
		#PROMPT(022) = FIELD_PROMPT(TAX_REFERENCE)
		#PROMPT(023) = FIELD_PROMPT(SYS_TAX_REFERENCE_BRANCH)
		#PROMPT(024) = FIELD_PROMPT(SYS_TARIFF_CODE)
		#PROMPT(025) = FIELD_PROMPT(SYS_EC_PROCESSED_INDICATOR)

		IF (#PRINT_LANGUAGE <> #NATIVE_LANGUAGE_CODE)
			! If printing on preprinted stationary
			! but the customer language is foreign
			! Delivery Date will still have to be in the
			! customer's language

			FIND IN SYS_DOCUMENT_PROMPTS &
				/LOCK=NONE &
				/WITH=SYS_DOCUMENT_CODE=#DOCUMENT_NAME &
				/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
				/WITH=SEQUENCE=19

			IF (%STATUS = %SUCCESS)
				#PROMPT(019)=SYS_DOCUMENT_PROMPTS(SYS_LANGUAGE_PROMPT)
			END_IF

			FIND IN SYS_DOCUMENT_PROMPTS &
				/LOCK=NONE &
				/WITH=SYS_DOCUMENT_CODE=#DOCUMENT_NAME &
				/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE &
				/WITH=SEQUENCE=20

			IF (%STATUS = %SUCCESS)
				#PROMPT(020)=SYS_DOCUMENT_PROMPTS(SYS_LANGUAGE_PROMPT)
			END_IF
		END_IF

		EXIT (%SUCCESS)
	END_BLOCK

	BEGIN_BLOCK GET_PROMPTS

		START_STREAM LA &
			/LOCK=NONE &
			/TABLE=SYS_DOCUMENT_PROMPTS &
			/WITH=SYS_DOCUMENT_CODE=#DOCUMENT_NAME &
			/WITH=SYS_LANGUAGE_CODE=#PRINT_LANGUAGE

		FETCH LA/FAILURE=(GOTO DEFAULT_PROMPTS)

		WHILE (1)
			#PROMPT(LA:SYS_DOCUMENT_PROMPTS(SEQUENCE))= &
				LA:SYS_DOCUMENT_PROMPTS(SYS_LANGUAGE_PROMPT)
			FETCH LA /FAILURE=(CONTINUE OUT)
		END_WHILE

		#PROMPT(028) = FIELD_PROMPT(SOP_SHIPPING_RUN_NUMBER)
		#PROMPT(029) = FIELD_PROMPT(SOP_LOAD_ID)
		#PROMPT(031) = FIELD_PROMPT(SYS_VERSION_NUMBER)
		#PROMPT(032) = FIELD_SHORT_PROMPT(TM_CONTAINER_SEAL)

		EXIT (%SUCCESS)
	END_BLOCK

	BEGIN_BLOCK DEFAULT_PROMPTS

		IF (#CALL_MODE = #CALL_MODE_WS) 
			! "No prompts for language !AS. Defaults used."
			PERFORM "GEMLB:LB_S_L_LOAD_MESSAGE" &
				("FIN", "P_12073", "", #ERR_WARN, 0, #PRINT_LANGUAGE, "", "", "", "")
		ELSE			
			MESSAGE/IDENTIFIER/BELL P_12073,#PRINT_LANGUAGE
		END_IF

		#PROMPT(002) = (MESSAGE("P_19059"))
			! Page
		#PROMPT(003) = (MESSAGE("P_6CORP_OFFICE_NAME_1"))
		#PROMPT(004) = (MESSAGE("P_00290"))
			! From
		#PROMPT(005) = FIELD_PROMPT(DESPATCH_NOTE)
		#PROMPT(006) = (MESSAGE("P_12104"))
			!Delivery Date
		#PROMPT(007) = FIELD_PROMPT(SALES_ORDER_HEADERS,SOP_DESTINATION_WAREHOUSE)
		#PROMPT(008) = FIELD_PROMPT(PHONE)

		#PROMPT(009) = FIELD_HEADING(DESPATCH_LINE)
		#PROMPT(010) = FIELD_HEADING(PART_CODE)
		#PROMPT(011) = FIELD_HEADING(WAREHOUSE)
		#PROMPT(012) = FIELD_HEADING(IC_LOT_NUMBER)
		#PROMPT(013) = FIELD_HEADING(PART_DESC_1)
		#PROMPT(014) = FIELD_HEADING(ORDER_NUMBER)
		#PROMPT(015) = FIELD_HEADING(ORDER_LINE_NUMBER)
		#PROMPT(016) = FIELD_PROMPT(REQUIRED_DATE)
!		#PROMPT(017) = FIELD_HEADING(UNIT_PICK)
!		#PROMPT(018) = FIELD_HEADING(DESPATCH_QTY_ACTUAL)
!		#PROMPT(017) = FIELD_HEADING(TM_UNIT_PACK)
		#PROMPT(018) = FIELD_HEADING(TM_NO_PACKS)

		#PROMPT(019) = FIELD_PROMPT(BIN_LOCATION)
		#PROMPT(020) = FIELD_SHORT_PROMPT(MH_NUMBER)

		#PROMPT(021) = FIELD_PROMPT(SYS_COUNTRY)
		#PROMPT(022) = FIELD_PROMPT(TAX_REFERENCE)
		#PROMPT(023) = FIELD_PROMPT(SYS_TAX_REFERENCE_BRANCH)
		#PROMPT(024) = FIELD_PROMPT(SYS_TARIFF_CODE)
		#PROMPT(025) = FIELD_PROMPT(SYS_EC_PROCESSED_INDICATOR)
		#PROMPT(026) = FIELD_HEADING(IC_LOT_SEQUENCE)
		#PROMPT(027) = MESSAGE("P_82962")
			! MSDS Required
		#PROMPT(028) = FIELD_PROMPT(SOP_SHIPPING_RUN_NUMBER)
		#PROMPT(029) = FIELD_PROMPT(SOP_LOAD_ID)
		#PROMPT(031) = FIELD_PROMPT(SYS_VERSION_NUMBER)
		#PROMPT(032) = FIELD_SHORT_PROMPT(TM_CONTAINER_SEAL)
	END_BLOCK
END_FORM


PROCEDURE_FORM SHIPPING_UPDATE_PRINT_FLAG       &
        /TABLE=DESPATCH_NOTES &
	/LOCK=WRITE &
	/COMMIT_RATE=1 &
        /WITH=COMPANY_CODE=#COMPANY_CODE &
        /WITH=DIVISION=#DIVISION &
        /WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER &
        /WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID &
        /WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES &
        /WITH=CONFIRM_DESPATCH = #NO    &
        /WITH=TM_LOAD_PLANNING = #YES   &
        /WITH=PRINT_FLAG =(PARAMETER("LANGUAGE_NO"))  &
        /WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
        /WITH=WAREHOUSE = "" &
        /WITH=WAREHOUSE MISSING &
        /SELECTION="A AND B AND C AND D AND E AND F AND G AND H AND (I OR J OR K)" &

        BEGIN_BLOCK FLAG_IT
                DESPATCH_NOTES(PRINT_FLAG)              = (PARAMETER("LANGUAGE_YES"))
                DESPATCH_NOTES(DATA_CAPTURE_CONFIRM)    = #DATA_CAPTURE_IN_USE
        END_BLOCK
END_FORM


PROCEDURE_FORM UPDATE_PRINT_FLAG        &
        /TABLE=DESPATCH_NOTES   &
	/LOCK=WRITE &
	/COMMIT_RATE=1 &
        /WITH=COMPANY_CODE=#COMPANY_CODE &
        /WITH=DIVISION=#DIVISION &
        /WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES &
        /WITH=CONFIRM_DESPATCH=(PARAMETER("LANGUAGE_NO")) &
        /WITH=PRINT_FLAG =(PARAMETER("LANGUAGE_NO"))  &
        /WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
        /WITH=WAREHOUSE = "" &
        /WITH=WAREHOUSE MISSING &
        /SELECTION="A AND B AND C AND D AND E AND (F OR G OR H)"

        BEGIN_BLOCK FLAG_IT
                DESPATCH_NOTES(PRINT_FLAG)              = (PARAMETER("LANGUAGE_YES"))
                DESPATCH_NOTES(DATA_CAPTURE_CONFIRM)    = #DATA_CAPTURE_IN_USE
        END_BLOCK

END_FORM


PROCEDURE_FORM SHIP_INCREMENT_VERSION	&
	/TABLE=DESPATCH_NOTES	&
	/LOCK=NONE	&
	/WITH=COMPANY_CODE=#COMPANY_CODE &
	/WITH=DIVISION=#DIVISION &
	/WITH=SOP_SHIPPING_RUN_NUMBER = #SHIPPING_RUN_NUMBER &
	/WITH=SOP_LOAD_ID AMONG #SOP_LOAD_ID	&
	/WITH=DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=CONFIRM_DESPATCH=#NO	&
	/WITH=TM_LOAD_PLANNING = #YES	&
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
	/SELECTION="A AND B AND C AND D AND E AND F AND G AND (H OR I OR J)"	&
	/REDUCED_TO = DESPATCH_NOTE

	BEGIN_BLOCK SET
		FIND IN DESPATCH_HEADERS	&
			/LOCK = WRITE	&
			/WITH=COMPANY_CODE = #COMPANY_CODE	&
			/WITH=DIVISION = DESPATCH_NOTES(DIVISION)	&
			/WITH=DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE)	&
			/WITH=DESPATCH_NUMBER = DESPATCH_NOTES(DESPATCH_NUMBER)
		IF (%STATUS = %SUCCESS)
			DESPATCH_HEADERS(SYS_VERSION_NUMBER) = DESPATCH_HEADERS(SYS_VERSION_NUMBER) + 1
		END_IF

	END_BLOCK

END_FORM

PROCEDURE_FORM SALES_INCREMENT_VERSION	&
	/TABLE=DESPATCH_NOTES,CUSTOMER_ADDRESSES &
        /LOCK=NONE      &
	/WITH=A.COMPANY_CODE=#COMPANY_CODE &
	/WITH=A.DIVISION=#DIVISION &
	/WITH=A.DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=A.CONFIRM_DESPATCH=(PARAMETER("LANGUAGE_NO")) &
	/WITH=B.COMPANY_CODE=A.COMPANY_CODE &
	/WITH=B.DIVISION=A.DIVISION &
	/WITH=B.CUSTOMER_NUMBER=A.CUSTOMER_NUMBER &
	/WITH=B.ADDRESS_CODE=A.DELIVERY_ADDRESS_CODE &
	/WITH=B.SYS_LANGUAGE_CODE AMONG #LANGUAGE_CODE &
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
	/SELECTION="A AND B AND C AND D AND E AND F AND G AND H AND I AND (J OR K OR L)" &
	/REDUCED_TO=A.DESPATCH_NOTE

	BEGIN_BLOCK SET
		FIND IN DESPATCH_HEADERS	&
			/LOCK = WRITE	&
			/WITH=COMPANY_CODE = #COMPANY_CODE	&
			/WITH=DIVISION = DESPATCH_NOTES(DIVISION)	&
			/WITH=DESPATCH_NOTE = DESPATCH_NOTES(DESPATCH_NOTE)	&
			/WITH=DESPATCH_NUMBER = DESPATCH_NOTES(DESPATCH_NUMBER)
		IF (%STATUS = %SUCCESS)
			DESPATCH_HEADERS(SYS_VERSION_NUMBER) = DESPATCH_HEADERS(SYS_VERSION_NUMBER) + 1
		END_IF

	END_BLOCK

END_FORM

!FBC FOF_001 Begin
PROCEDURE_FORM FOF_GENERATE_REPORT
	BEGIN_BLOCK FIND_CONTROLS
		FIND IN FOF_CONTROLS &
			/LOCK=NONE

		IF (%STATUS<>%NORMAL)
			EXIT(%FAILURE)
		END_IF
	END_BLOCK

	BEGIN_BLOCK REPORT_NAME
		#FOF_EXTENSION=FOF_CONTROLS(FOF_EXTENSION)
		#FOF_DIRECTORY=FOF_CONTROLS(FOF_DIRECTORY)

		PERFORM "GEMLB:LB_REPORT_PRINT_CONTROL"(&
			#ID,#ID&"/1","","","",#R_NAME,&
			#REPORT_AUTO,#QUEUE,#FORM_TYPE,#COPIES,"","","")

		#I=POS(#R_NAME,".",1)
		#R_NAME_FOF=#FOF_DIRECTORY & LEFT(#R_NAME,#I) & #FOF_EXTENSION
	END_BLOCK
	BEGIN_BLOCK FOF_GENERATE
		PERFORM FOF_CREATE_ENV
!FBC FOF002 Begin
!		PERFORM FOF_MAKE_FILE
		IF (%STATUS<>%EMPTY)
			PERFORM FOF_MAKE_FILE
			PERFORM "GEMFOF:FOF_ENGINE" SEND_OUTPUT (#R_NAME, #R_NAME_FOF)
		END_IF
!FBC FOF002 End
	END_BLOCK
END_FORM

PROCEDURE_FORM FOF_CREATE_VT

	BEGIN_BLOCK CHECK_TABLE
		IF (TABLE_CHECK("FOF_TABLE_KEYS_VT","")=%NORMAL)
			DELETE TABLE FOF_TABLE_KEYS_VT
		END_IF
	END_BLOCK

	BEGIN_BLOCK CREATE_TABLE
		ADD TABLE FOF_TABLE_KEYS_VT &
			/VIRTUAL &
			/ADD_FIELD=COMPANY_CODE &
			/ADD_FIELD=DIVISION &
			/ADD_FIELD=DESPATCH_NOTE &
			/ADD_FIELD=DESPATCH_NUMBER &
			/ADD_FIELD=DESPATCH_LINE &
			/ADD_FIELD=SYS_LANGUAGE_CODE

	END_BLOCK

END_FORM

PROCEDURE_FORM FOF_CREATE_ENV &
	/TABLE=DESPATCH_NOTES,CUSTOMER_ADDRESSES &
	/WITH=A.COMPANY_CODE=#COMPANY_CODE &
	/WITH=A.DIVISION=#DIVISION &
	/WITH=A.DESPATCH_NOTE AMONG #DESPATCH_NOTES &
	/WITH=A.CONFIRM_DESPATCH=(PARAMETER("LANGUAGE_NO")) &
	/WITH=B.COMPANY_CODE=A.COMPANY_CODE &
	/WITH=B.DIVISION=A.DIVISION &
	/WITH=B.CUSTOMER_NUMBER=A.CUSTOMER_NUMBER &
	/WITH=B.ADDRESS_CODE=A.DELIVERY_ADDRESS_CODE &
	/WITH=B.SYS_LANGUAGE_CODE AMONG #LANGUAGE_CODE &
	/WITH=WAREHOUSE AMONG #ACCESSIBLE_WAREHOUSES &
	/WITH=WAREHOUSE = "" &
	/WITH=WAREHOUSE MISSING &
	/SELECTION="A AND B AND C AND D AND E AND F AND G AND H AND I AND (J OR K OR L)" &
	/SORTED_BY=(CUSTOMER_NUMBER,DELIVERY_ADDRESS_CODE,DESPATCH_NOTE,DESPATCH_LINE,ORDER_NUMBER,PROMISED_DATE,PART_CODE) &
	/BREAK0=FOF_CREATE_VT

	BEGIN_BLOCK FIND_LANGUAGE

		#PRINT_LANGUAGE = CUSTOMER_ADDRESSES(SYS_LANGUAGE_CODE)

	END_BLOCK

	BEGIN_BLOCK ADD_TO_VIRTUAL_TABLE
		FOF_TABLE_KEYS_VT(COMPANY_CODE)=DESPATCH_NOTES(COMPANY_CODE)
		FOF_TABLE_KEYS_VT(DIVISION)=DESPATCH_NOTES(DIVISION)
		FOF_TABLE_KEYS_VT(DESPATCH_NOTE)=DESPATCH_NOTES(DESPATCH_NOTE)
		FOF_TABLE_KEYS_VT(DESPATCH_NUMBER)=DESPATCH_NOTES(DESPATCH_NUMBER)
		FOF_TABLE_KEYS_VT(DESPATCH_LINE)=DESPATCH_NOTES(DESPATCH_LINE)
		FOF_TABLE_KEYS_VT(SYS_LANGUAGE_CODE)=#PRINT_LANGUAGE
		ADD TO FOF_TABLE_KEYS_VT
	END_BLOCK

END_FORM

REPORT_FORM FOF_MAKE_FILE &
	/OPTIONS=INFINITE &
	/OUTPUT=#R_NAME &
	/WIDTH=6000

	PERFORM "GEMFOF:FOF_ENGINE" PRINT_JOB (#ID,4)
	PERFORM "GEMFOF:FOF_SOP_R_DESPATCH_PRINT"

END_FORM

